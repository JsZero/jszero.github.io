{"pages":[{"title":"å…³äºŽ","text":"ä¸€ä¸ªèœé¸Ÿç å†œçš„ç©ºé—´ðŸ” æ²¿é€”çš„é£Žæ™¯ ðŸ• å®¶é‡Œçš„å°æŸ´çŠ¬â€œå·é¥¼â€ ðŸŽ¶ å¬è¿‡çš„æ¼”å”±ä¼š ðŸ² å“å°è¿‡çš„ç¾Žé£Ÿ","link":"/about/index.html"}],"posts":[{"title":"Akkaä½¿ç”¨æ•™ç¨‹","text":"Akka æ˜¯ä¸€ä¸ªç”¨ Scala ç¼–å†™çš„åº“ï¼Œç”¨äºŽåœ¨ JVM å¹³å°ä¸Šç®€åŒ–ç¼–å†™å…·æœ‰å¯å®¹é”™çš„ã€é«˜å¯ä¼¸ç¼©æ€§çš„ Java å’Œ Scala çš„ Actor æ¨¡åž‹åº”ç”¨ï¼Œå…¶åŒæ—¶æä¾›äº†Java å’Œ Scala çš„å¼€å‘æŽ¥å£ã€‚Akka å…è®¸æˆ‘ä»¬ä¸“æ³¨äºŽæ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œè€Œä¸æ˜¯ç¼–å†™åˆçº§ä»£ç ã€‚åœ¨ Akka ä¸­ï¼ŒActor ä¹‹é—´é€šä¿¡çš„å”¯ä¸€æœºåˆ¶å°±æ˜¯æ¶ˆæ¯ä¼ é€’ã€‚Akka å¯¹ Actor æ¨¡åž‹çš„ä½¿ç”¨æä¾›äº†ä¸€ä¸ªæŠ½è±¡çº§åˆ«ï¼Œä½¿å¾—ç¼–å†™æ­£ç¡®çš„å¹¶å‘ã€å¹¶è¡Œå’Œåˆ†å¸ƒå¼ç³»ç»Ÿæ›´åŠ å®¹æ˜“ã€‚Actor æ¨¡åž‹è´¯ç©¿äº†æ•´ä¸ª Akka åº“ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€è‡´çš„ç†è§£å’Œä½¿ç”¨å®ƒä»¬çš„æ–¹æ³• ActorsIntroduction to Actorså¾…è¡¥å……","link":"/2022/07/02/Akka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"},{"title":"DolphinScheduleræºç é˜…è¯»æ—¥è®°ï¼ˆä¸‰ï¼‰é€šä¿¡æœºåˆ¶","text":"æ¦‚è¿°DolphinSchedulerçš„é€šä¿¡æœºåˆ¶æ˜¯é€šè¿‡Nettyæ¥å®žçŽ°çš„ï¼Œåœ¨Nettyä¸ŠåŠ åšäº†ä¸€äº›å°è£…å’ŒæŠ½è±¡ Nettyç®€ä»‹åŠŸèƒ½ä»‹ç»Netty æ˜¯ä¸€ä¸ªåŸºäºŽ Java çš„é«˜æ€§èƒ½ç½‘ç»œåº”ç”¨æ¡†æž¶ï¼Œå¹¿æ³›ç”¨äºŽå¼€å‘é«˜å¹¶å‘ã€ä½Žå»¶è¿Ÿçš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚å®ƒæä¾›äº†ä¸€ç»„ä¸°å¯Œçš„ API å’Œå·¥å…·ï¼Œç®€åŒ–äº†ç½‘ç»œé€šä¿¡çš„å¼€å‘è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿žæŽ¥å’Œæ•°æ®æµæ—¶ã€‚ ä¸ºå„ç§ä¼ è¾“ç±»åž‹ï¼ˆé˜»å¡žå’Œéžé˜»å¡žsocketï¼‰æä¾›ç»Ÿä¸€API åŸºäºŽçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡åž‹ï¼Œå…è®¸æ˜Žç¡®åˆ†ç¦»å…³æ³¨ç‚¹ é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡åž‹â€”â€”å•çº¿ç¨‹ã€ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ± ï¼ˆå¦‚ SEDAï¼‰ çœŸæ­£çš„æ— è¿žæŽ¥æ•°æ®æŠ¥socketæ”¯æŒï¼ˆè‡ª3.1ç‰ˆèµ·ï¼‰ åŸºç¡€æ¦‚å¿µ table th:first-of-type {width: 20%;} table th:nth-of-type(2) {width: 80%;} æ¦‚å¿µ å«ä¹‰ Channel Channel æ˜¯ Netty ä¸­ç”¨äºŽç½‘ç»œé€šä¿¡çš„åŸºæœ¬æŠ½è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªåˆ°ç½‘ç»œå¥—æŽ¥å­—ï¼ˆSocketï¼‰çš„è¿žæŽ¥ã€‚å®ƒç±»ä¼¼äºŽ Java NIO çš„ Channelï¼Œä½†æä¾›äº†æ›´å¤šçš„é«˜çº§åŠŸèƒ½ã€‚Channel å¯ä»¥æ˜¯ TCPã€UDP æˆ–è€…æ–‡ä»¶ä¼ è¾“ç­‰ä¸åŒç±»åž‹çš„è¿žæŽ¥ EventLoop EventLoop æ˜¯ Netty ä¸­çš„äº‹ä»¶å¤„ç†æ ¸å¿ƒã€‚æ¯ä¸ª EventLoop éƒ½ä¸Žä¸€ä¸ªæˆ–å¤šä¸ª Channel å…³è”ï¼Œè´Ÿè´£å¤„ç†è¿™äº› Channel ä¸Šçš„æ‰€æœ‰ I/O æ“ä½œï¼ŒåŒ…æ‹¬è¯»å†™äº‹ä»¶çš„è°ƒåº¦ã€‚EventLoop ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…çº¿ç¨‹é—´ç«žäº‰ ChannelHandler ChannelHandler æ˜¯ç”¨äºŽå¤„ç† Channel ä¸Šçš„ I/O äº‹ä»¶çš„ç»„ä»¶ã€‚Netty é€šè¿‡ ChannelHandler å®žçŽ°äº†çµæ´»çš„äº‹ä»¶å¤„ç†æœºåˆ¶ã€‚å¸¸è§çš„ ChannelHandler ç±»åž‹åŒ…æ‹¬ ChannelInboundHandler å’Œ ChannelOutboundHandlerï¼Œåˆ†åˆ«ç”¨äºŽå¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ® Pipeline Pipeline æ˜¯ Netty ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒæ˜¯ ChannelHandler çš„æœ‰åºé“¾è¡¨ã€‚æ‰€æœ‰ä¸Ž Channel ç›¸å…³çš„äº‹ä»¶ï¼ˆå¦‚è¯»ã€å†™ã€è¿žæŽ¥ç­‰ï¼‰éƒ½ä¼šæ²¿ç€ Pipeline ä¾æ¬¡ä¼ é€’ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦åœ¨ Pipeline ä¸­æ’å…¥ä¸åŒçš„ ChannelHandler æ¥å®žçŽ°å®šåˆ¶çš„é€»è¾‘ Bootstrap Bootstrap æ˜¯ç”¨äºŽé…ç½®å’Œå¯åŠ¨å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯ Channel çš„ç±»ã€‚å®ƒç®€åŒ–äº†ç½‘ç»œåº”ç”¨ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ Bootstrap è®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚çº¿ç¨‹æ± ã€äº‹ä»¶å¤„ç†å™¨ç­‰ ByteBuf ByteBuf æ˜¯ Netty æä¾›çš„ç”¨äºŽé«˜æ•ˆå¤„ç†å­—èŠ‚æ•°æ®çš„ç¼“å†²åŒºã€‚ä¸Ž Java NIO ä¸­çš„ ByteBuffer ä¸åŒï¼ŒByteBuf æä¾›äº†æ›´å¤šçš„æ“ä½œæ–¹æ³•ï¼Œå¹¶ä¸”æ”¯æŒåŠ¨æ€æ‰©å±•ã€å¼•ç”¨è®¡æ•°ç­‰ç‰¹æ€§ï¼Œæžå¤§åœ°æé«˜äº†å¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„æ•ˆçŽ‡ Future&amp;Promise Future å’Œ Promise æ˜¯ Netty ä¸­çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡åž‹ï¼Œç”¨äºŽè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ç»“æžœã€‚Future è¡¨ç¤ºä¸€ä¸ªå°šæœªå®Œæˆçš„æ“ä½œç»“æžœï¼Œè€Œ Promise åˆ™æ˜¯å¯ä»¥æ‰‹åŠ¨è®¾ç½®ç»“æžœçš„ Futureã€‚è¿™ä¸¤ä¸ªæŽ¥å£å¸®åŠ©å¼€å‘è€…å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„å›žè°ƒé€»è¾‘ Transport Transport æ˜¯ Netty ä¸­çš„åº•å±‚æŠ½è±¡ï¼Œè´Ÿè´£å®žçŽ°å…·ä½“çš„ç½‘ç»œåè®®ï¼ˆå¦‚ TCPã€UDPï¼‰çš„ä¼ è¾“æœºåˆ¶ã€‚ä¸åŒçš„ Transport å®žçŽ°å¯ä»¥æœ‰ä¸åŒçš„ I/O æ¨¡åž‹ï¼ˆå¦‚ NIOã€Epoll ç­‰ï¼‰ï¼Œé€‚ç”¨äºŽä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œæ€§èƒ½éœ€æ±‚ é€šä¿¡æœºåˆ¶å®žçŽ°å…³é”®ç±»åœ¨MasterServerã€WorkerServerä¸­åˆ†åˆ«éƒ½å­˜åœ¨ä¸€ä¸ªRpcServerå’ŒRpcClientï¼Œç”¨äºŽä½œä¸ºRPCçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ åºåˆ—åŒ–ä¸Žååºåˆ—åŒ–Messgaeçš„åºåˆ—åŒ–ä¸Žååºåˆ—åŒ– äº‹ä»¶å¤„ç†å™¨å¦‚ä½•æ˜ å°„åˆ°å¯¹åº”çš„Processorå¤„ç†ï¼ˆå€¼å¾—å€Ÿé‰´ï¼‰##","link":"/2024/08/23/DolphinScheduler%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/"},{"title":"DolphinScheduleræºç é˜…è¯»æ—¥è®°ï¼ˆäºŒï¼‰MasterServerå·¥ä½œæµè°ƒåº¦æºç è§£æž","text":"ç³»ç»Ÿæž¶æž„ MasterServer MasterServeré‡‡ç”¨åˆ†å¸ƒå¼æ— ä¸­å¿ƒè®¾è®¡ç†å¿µï¼ŒMasterServerä¸»è¦è´Ÿè´£ DAG ä»»åŠ¡åˆ‡åˆ†ã€ä»»åŠ¡æäº¤ç›‘æŽ§ï¼Œå¹¶åŒæ—¶ç›‘å¬å…¶å®ƒMasterServerå’ŒWorkerServerçš„å¥åº·çŠ¶æ€ã€‚ MasterServeræœåŠ¡å¯åŠ¨æ—¶å‘Zookeeperæ³¨å†Œä¸´æ—¶èŠ‚ç‚¹ï¼Œé€šè¿‡ç›‘å¬Zookeeperä¸´æ—¶èŠ‚ç‚¹å˜åŒ–æ¥è¿›è¡Œå®¹é”™å¤„ç†ã€‚ MasterServeråŸºäºŽnettyæä¾›ç›‘å¬æœåŠ¡ã€‚ è¯¥æœåŠ¡å†…ä¸»è¦åŒ…å«: DistributedQuartz: åˆ†å¸ƒå¼è°ƒåº¦ç»„ä»¶ï¼Œä¸»è¦è´Ÿè´£å®šæ—¶ä»»åŠ¡çš„å¯åœæ“ä½œï¼Œå½“quartzè°ƒèµ·ä»»åŠ¡åŽï¼ŒMasterå†…éƒ¨ä¼šæœ‰çº¿ç¨‹æ± å…·ä½“è´Ÿè´£å¤„ç†ä»»åŠ¡çš„åŽç»­æ“ä½œï¼› MasterSchedulerService: æ˜¯ä¸€ä¸ªæ‰«æçº¿ç¨‹ï¼Œå®šæ—¶æ‰«ææ•°æ®åº“ä¸­çš„t_ds_commandè¡¨ï¼Œæ ¹æ®ä¸åŒçš„å‘½ä»¤ç±»åž‹è¿›è¡Œä¸åŒçš„ä¸šåŠ¡æ“ä½œï¼› WorkflowExecuteRunnable: ä¸»è¦æ˜¯è´Ÿè´£DAGä»»åŠ¡åˆ‡åˆ†ã€ä»»åŠ¡æäº¤ç›‘æŽ§ã€å„ç§ä¸åŒäº‹ä»¶ç±»åž‹çš„é€»è¾‘å¤„ç†ï¼› TaskExecuteRunnable: ä¸»è¦è´Ÿè´£ä»»åŠ¡çš„å¤„ç†å’ŒæŒä¹…åŒ–ï¼Œå¹¶ç”Ÿæˆä»»åŠ¡äº‹ä»¶æäº¤åˆ°å·¥ä½œæµçš„äº‹ä»¶é˜Ÿåˆ—ï¼› EventExecuteService: ä¸»è¦è´Ÿè´£å·¥ä½œæµå®žä¾‹çš„äº‹ä»¶é˜Ÿåˆ—çš„è½®è¯¢ï¼› StateWheelExecuteThread: ä¸»è¦è´Ÿè´£å·¥ä½œæµå’Œä»»åŠ¡è¶…æ—¶ã€ä»»åŠ¡é‡è¯•ã€ä»»åŠ¡ä¾èµ–çš„è½®è¯¢ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„å·¥ä½œæµæˆ–ä»»åŠ¡äº‹ä»¶æäº¤åˆ°å·¥ä½œæµçš„äº‹ä»¶é˜Ÿåˆ—ï¼› FailoverExecuteThread: ä¸»è¦è´Ÿè´£Masterå®¹é”™å’ŒWorkerå®¹é”™çš„ç›¸å…³é€»è¾‘ï¼› æ ¸å¿ƒæ¦‚å¿µ table th:first-of-type {width: 25%;} table th:nth-of-type(2) {width: 75%;} æ¦‚å¿µ å«ä¹‰ Process Definition å·¥ä½œæµå®šä¹‰ Process Instance å·¥ä½œæµå®žä¾‹ï¼Œå®žé™…è¿è¡Œæ—¶ä¼šè¢«åŒ…è£…ä¸ºWorkflowExecuteRunnable Command äº‹ä»¶æ¶ˆæ¯ å…³é”®æµç¨‹åˆ†æž ä»¥ä¸‹æµç¨‹éƒ½åœ¨MasterServerä¸­æ‰§è¡Œï¼Œä¸å†åœ¨æ ‡é¢˜ä¸­èµ˜è¿° æ‹‰å–äº‹ä»¶MasterSchedulerBootstrapæ˜¯ç”¨äºŽä»ŽMySQLä¸­æ‹‰å–äº‹ä»¶ï¼ˆCommandï¼‰çš„ä¸»è¦çº¿ç¨‹ï¼Œåœ¨MasterServerå¯åŠ¨æ—¶å¯åŠ¨ï¼Œé€šè¿‡findCommands()æ–¹æ³•æ‰¾åˆ°å¾…æ‰§è¡Œçš„äº‹ä»¶ï¼Œè¿™é‡Œçš„äº‹ä»¶ä¸ä»…é™äºŽå¼€å§‹æ‰§è¡Œå·¥ä½œæµï¼Œè¿˜æœ‰å…¶ä»–ç±»åž‹ï¼Œå…·ä½“å‚è€ƒCommandTypeçš„å®šä¹‰ï¼Œå¦‚ä¸‹ è€Œæ‹‰å–äº‹ä»¶æµç¨‹ä¸­ï¼Œå¦‚ä¸‹ é‡‡ç”¨æ— ä¸­å¿ƒèŠ‚ç‚¹è®¾è®¡ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡å–æ¨¡çš„æ–¹å¼èŽ·å–å½“å‰èŠ‚ç‚¹åº”è¯¥å¤„ç†çš„äº‹ä»¶ã€‚èŠ‚ç‚¹æ€»æ•°å’Œå½“å‰èŠ‚ç‚¹çš„åºå·æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿä»Žæ³¨å†Œä¸­å¿ƒï¼ˆZK/ETCD/JDBCï¼‰èŽ·å–æ‰€æœ‰èŠ‚ç‚¹åˆ—è¡¨ï¼Œåœ¨æœ¬åœ°ç”Ÿæˆåºå·ï¼Œè¯¦æƒ…å‚è€ƒorg.apache.dolphinscheduler.service.queue.MasterPriorityQueue.ServerComparator å¤„ç†äº‹ä»¶ï¼Œåˆ›å»ºå·¥ä½œæµå¤„ç†äº‹ä»¶ï¼Œåˆ›å»ºå·¥ä½œæµåœ¨ï¼Œå¦‚ä¸‹ è€Œåˆ›å»ºå·¥ä½œæµå…·ä½“åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªé˜¶æ®µï¼ŒProcessDefinition -&gt; ProcessInstance (WorkflowInstance) -&gt; WorkflowExecuteContext -&gt; WorkflowExecuteRunnableï¼Œäº§ç”ŸWorkflowExecuteRunnableå®žä¾‹å³ä¸ºæœ€ç»ˆéœ€è¦è°ƒåº¦çš„å·¥ä½œæµ 1234567891011121314// ProcessDefinition -&gt; ProcessInstance(WorkflowInstance)org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteContextFactory#createWorkflowExecuteRunnableContext:56org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteContextFactory#createWorkflowInstance:81org.apache.dolphinscheduler.service.process.ProcessServiceImpl#handleCommand:317org.apache.dolphinscheduler.service.process.ProcessServiceImpl#constructProcessInstance:768org.apache.dolphinscheduler.service.process.ProcessServiceImpl#generateNewProcessInstance:586// ProcessInstance(WorkflowInstance) -&gt; WorkflowExecuteContextorg.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnableFactory#createWorkflowExecuteRunnable:79org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteContextFactory#createWorkflowExecuteRunnableContext:67// WorkflowExecuteContext -&gt; WorkflowExecuteRunnableorg.apache.dolphinscheduler.server.master.runner.MasterSchedulerBootstrap#run:137org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnableFactory#createWorkflowExecuteRunnable:80 å·¥ä½œæµè¢«åˆ›å»ºå‡ºæ¥ä¹‹åŽä¼šç”Ÿæˆä¸€ä¸ªå·¥ä½œæµäº‹ä»¶WorkflowEventï¼Œæ”¾åœ¨å†…å­˜çš„é˜»å¡žé˜Ÿåˆ—workflowEventQueueå½“ä¸­ è°ƒåº¦å·¥ä½œæµMasterSchedulerBootstrapçº¿ç¨‹å¯åŠ¨åŽï¼Œè¿˜ä¼šå†å¯åŠ¨ä¸€ä¸ªWorkflowEventLooperå·¥ä½œæµäº‹ä»¶å¤„ç†çº¿ç¨‹ï¼Œç”¨äºŽæ¶ˆè´¹ä¸Šä¸€æ­¥æ”¾å…¥å†…å­˜çš„é˜»å¡žé˜Ÿåˆ—workflowEventQueueå½“ä¸­çš„å·¥ä½œæµäº‹ä»¶WorkflowEvent WorkflowEventLooperçº¿ç¨‹ä¼šä½¿ç”¨WorkflowEventHandlerå¤„ç†å·¥ä½œæµäº‹ä»¶ WorkflowEventHandlerä¼šå°†é€šè¿‡è°ƒç”¨WorkflowExecuteRunnableå·¥ä½œæµçš„call()æ–¹æ³•ï¼Œå°†å·¥ä½œæµçš„å¯åŠ¨å¼‚æ­¥æäº¤åˆ°WorkflowExecuteThreadPoolçº¿ç¨‹æ± ä¸­æ‰§è¡Œ æœ€ç»ˆè°ƒç”¨å·¥ä½œæµçš„submitPostNode()æ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡Œå·¥ä½œæµçš„èŠ‚ç‚¹ è§£æžå·¥ä½œæµèŠ‚ç‚¹èŽ·å–å¾…æäº¤çš„TaskNodeåˆ—è¡¨submitTaskNodeListï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„TaskInstanceå®žä¾‹TODO è§£æžè¿‡ç¨‹æ¯”æƒ³è±¡çš„å¤æ‚ï¼Œéœ€è¦è¯¦è§£åˆ†æžä¸‹ å°†ä»»åŠ¡æ·»åŠ åˆ°å†…å­˜ä¸­çš„standbyä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆå †ï¼‰readyToSubmitTaskQueueä¸­ï¼Œå¹¶åœ¨å¼€å§‹æäº¤ä»»åŠ¡ ä¹‹åŽåˆ†å‘æ­¥éª¤æ¯”è¾ƒå¤æ‚ï¼Œå…·ä½“æ‹†è§£å¦‚ä¸‹ 1234567891011121314// å¼€å§‹æäº¤ä»»åŠ¡org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnable#submitStandByTask:1967// ç”Ÿæˆä»»åŠ¡å®žä¾‹ï¼ˆTaskExecuteRunnableï¼‰org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnable#executeTask:956// å¼€å§‹åˆ†å‘ä»»åŠ¡å®žä¾‹org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnable#executeTask:993// åˆ†å‘org.apache.dolphinscheduler.server.master.runner.WorkflowExecuteRunnable#tryToDispatchTaskInstance:1011// ä½¿ç”¨TaskDispatchOperatoråˆ†å‘org.apache.dolphinscheduler.server.master.runner.execute.DefaultTaskExecuteRunnable#dispatch:41 // å°†ä»»åŠ¡æ·»åŠ åˆ°globalTaskDispatchWaitingQueueä¸­org.apache.dolphinscheduler.server.master.runner.operator.TaskDispatchOperator#handle:34// GlobalTaskDispatchWaitingQueueLooperçº¿ç¨‹è½®è¯¢queueï¼Œä½¿ç”¨BaseTaskDispatcheråˆ†å‘ä»»åŠ¡å®žä¾‹ç»™workerorg.apache.dolphinscheduler.server.master.runner.GlobalTaskDispatchWaitingQueueLooper#run:79 æœ€åŽä½¿ç”¨æ‰¾åˆ°å¯ç”¨workerèŠ‚ç‚¹ï¼Œé€šè¿‡rpcå¯åŠ¨å¾…æ‰§è¡Œä»»åŠ¡","link":"/2024/07/28/DolphinScheduler%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E6%97%A5%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89MasterServer%E5%B7%A5%E4%BD%9C%E6%B5%81%E8%B0%83%E5%BA%A6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"},{"title":"DolphinScheduleræºç é˜…è¯»æ—¥è®°ï¼ˆä¸€ï¼‰å¼€å‘çŽ¯å¢ƒæ­å»º","text":"ç³»ç»ŸçŽ¯å¢ƒ çŽ¯å¢ƒ ç‰ˆæœ¬ ç³»ç»Ÿ macOS 12.2.1/m1 pro JRE Zulu 8.62.0.19-CA-macos-aarch64 Maven 3.8.6 Node 18.4.0 Pnpm 7.3.0 Zookeeper 3.8.4 MySQL 8.0.28 DolphinScheduler 3.2.0 æ­å»ºé¡¹ç›®å¼€å‘çŽ¯å¢ƒé¡¹ç›®ä¸‹è½½ä»Žgithubä¸‹è½½æºç ä»Ždolphinscheduleræºç ä»“åº“ä¸‹è½½æºç  12git clone https://github.com/apache/dolphinschedulergit checkout 3.2.0 # åˆ‡æ¢åˆ°3.2.0åˆ†æ”¯ Zookeeperä¸‹è½½äºŒè¿›åˆ¶å¯æ‰§è¡ŒåŒ… ä¸‹è½½Zookeeper 3.8.4äºŒè¿›åˆ¶å¯æ‰§è¡ŒåŒ… åˆ›å»ºæ–‡ä»¶&amp;æ—¥å¿—ç›®å½• è§£åŽ‹åŽ‹ç¼©åŒ…ï¼Œåˆ›å»ºdataã€datalogç›®å½• 123cd /Users/jiashaoqi/plugin/zookeepertar -zxvf apache-zookeeper-3.8.4-bin.tar.gzmkdir data datalog ä¿®æ”¹é…ç½®æ–‡ä»¶å°†confç›®å½•ä¸‹çš„zoo_sample.cfgæ–‡ä»¶ï¼Œå¤åˆ¶ä¸€ä»½ï¼Œé‡å‘½åä¸ºzoo.cfgï¼Œä¿®æ”¹å…¶ä¸­æ•°æ®å’Œæ—¥å¿—çš„é…ç½®ï¼Œå¦‚ï¼š 123cd ./apache-zookeeper-3.8.4-bin/confcp zoo_sample.cfg zoo.cfgvi zoo.cfg æ·»åŠ çŽ¯å¢ƒå˜é‡12vi ~/.bash_profile # æ·»åŠ å†…å®¹å¦‚ä¸‹source ~/.bash_profile å¯åŠ¨Zookeeper1zkServer.sh start # è§åˆ°å¦‚å›¾æ‰€ç¤ºå³ä¸ºå¯åŠ¨æˆåŠŸ MySQLæ•°æ®åº“é…ç½®åˆå§‹åŒ–æ•°æ®åº“åŠè´¦å·åˆ›å»ºå®Œæ–°æ•°æ®åº“dolphinscheduleråŽï¼Œå°†dolphinscheduler/dolphinscheduler-dao/src/main/resources/sql/dolphinscheduler_mysql.sqlä¸‹çš„sqlæ–‡ä»¶ç›´æŽ¥åœ¨MySQLä¸­è¿è¡Œï¼Œå®Œæˆæ•°æ®åº“åˆå§‹åŒ– 1234567891011121314151617181920mysql&gt; create database dolphinscheduler;Query OK, 1 row affected (0.01 sec)mysql&gt; create user 'dolphin'@'localhost' identified by 'nihplod';Query OK, 0 rows affected (0.01 sec)mysql&gt; grant all privileges on dolphinscheduler.* to 'dolphin'@'localhost';Query OK, 0 rows affected (0.00 sec)mysql&gt; flush privileges;Query OK, 0 rows affected (0.00 sec)mysql&gt; use dolphinscheduler;Database changedmysql&gt; source /Users/jiashaoqi/workspace/idea/dolphinscheduler/dolphinscheduler-dao/src/main/resources/sql/dolphinscheduler_mysql.sql;Query OK, 1 row affected (0.00 sec)...Query OK, 1 row affected (0.00 sec) åŽç«¯Mavenä¾èµ–ä¸‹è½½é€šè¿‡ideaæ‰“å¼€é¡¹ç›®ï¼Œä¸‹è½½ä¾èµ–ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ æ³¨æ„ï¼šmavenä¸‹è½½ä¾èµ–å¯èƒ½ä¼šå‡ºçŽ°é—®é¢˜ï¼Œå¯¹äºŽä¸‹è½½å‡ºé”™çš„ä¾èµ–æˆ–è€…æ’ä»¶ï¼Œå¯ä»¥åˆ°æœ¬åœ°mavenä»“åº“ç›®å½•ä¸‹åˆ é™¤å¯¹åº”çš„å­ç›®å½•é‡æ–°ä¸‹è½½ï¼Œå¦‚åœ¨ä¸‹è½½ä¾èµ–åŽç¼–è¯‘æ—¶å‘ç”Ÿäº†å¦‚ä¸‹å¼‚å¸¸ 1java: è¯»å–/Users/jiashaoqi/plugin/maven/apache-maven-3.8.6/repo/io/fabric8/kubernetes-model-core/5.10.2/kubernetes-model-core-5.10.2.jaræ—¶å‡ºé”™; zip file is empty æ‰€ä»¥æ‰‹åŠ¨ä¸‹è½½ä¾èµ–kubernetes-model-core 12rm -rfv /Users/jiashaoqi/plugin/maven/apache-maven-3.8.6/repo/io/fabric8/kubernetes-model-core/5.10.2mvn dependency:get -DgroupId=io.fabric8 -DartifactId=kubernetes-model-core -Dversion=5.10.2 ä¿®æ”¹æ•°æ®åº“é…ç½® å°†dolphinscheduler-bom/pom.xmlæ–‡ä»¶ä¸­mysql-connector-javaä¾èµ–çš„scopeä¿®æ”¹ä¸ºcompile å°†å¦‚ä¸‹é…ç½®æ–‡ä»¶ä¸­çš„mysqlçš„datasourceé…ç½®ä¸ºå¦‚ä¸‹å†…å®¹12345dolphinscheduler-master/src/main/resources/application.yaml:151dolphinscheduler-alert/dolphinscheduler-alert-server/src/main/resources/application.yaml:93dolphinscheduler-api/src/main/resources/application.yaml:229dolphinscheduler-standalone-server/src/main/resources/application.yaml:305dolphinscheduler-tools/src/main/resources/application.yaml:49 é…ç½®å é…ç½®å€¼ datasource.driver-class-name com.mysql.cj.jdbc.Driver datasource.url jdbc:mysql://127.0.0.1:3306/dolphinscheduler datasource.username dolphin datasource.password nihplod ä¿®æ”¹æ—¥å¿—çº§åˆ«ä¸ºä»¥ä¸‹é…ç½®å¢žåŠ ä¸€è¡Œå†…å®¹ ä½¿æ—¥å¿—èƒ½åœ¨å‘½ä»¤è¡Œä¸­æ˜¾ç¤º 123dolphinscheduler-master/src/main/resources/logback-spring.xmldolphinscheduler-worker/src/main/resources/logback-spring.xmldolphinscheduler-api/src/main/resources/logback-spring.xml 12345&lt;root level=&quot;INFO&quot;&gt;+ &lt;appender-ref ref=&quot;STDOUT&quot;/&gt; &lt;appender-ref ref=&quot;APILOGFILE&quot;/&gt; &lt;appender-ref ref=&quot;SKYWALKING-LOG&quot;/&gt;&lt;/root&gt; å¯ä»¥å†åœ¨STDOUTè¿™ä¸ªappenderçš„patternä¸Šå¥—ä¸€ä¸ª%clr(...)ï¼Œè®©æ—¥å¿—åœ¨æŽ§åˆ¶å°ä¸Šé«˜äº®æ˜¾ç¤ºï¼Œå¦‚ 12345678910111213&lt;configuration scan=&quot;true&quot; scanPeriod=&quot;120 seconds&quot;&gt;+ &lt;include resource=&quot;org/springframework/boot/logging/logback/defaults.xml&quot; /&gt; &lt;!-- ... --&gt; &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &lt;encoder&gt; &lt;pattern&gt;+ %clr([%level] %date{yyyy-MM-dd HH:mm:ss.SSS Z} %logger{96}:[%line] - [WorkflowInstance-%X{workflowInstanceId:-0}][TaskInstance-%X{taskInstanceId:-0}] - %msg%n) &lt;/pattern&gt; &lt;charset&gt;UTF-8&lt;/charset&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- ... --&gt;&lt;/configuration&gt; ç¼–è¯‘æºä»£ç  è¿è¡ŒåŽç«¯æœåŠ¡å‚è€ƒDolphinScheduler æ™®é€šå¼€å‘æ¨¡å¼éœ€è¦å¯åŠ¨ä¸‰ä¸ªæœåŠ¡ï¼ŒåŒ…æ‹¬ MasterServerï¼ŒWorkerServerï¼ŒApiApplicationServer MasterServerï¼šåœ¨ Intellij IDEA ä¸­æ‰§è¡Œ org.apache.dolphinscheduler.server.master.MasterServer ä¸­çš„ main æ–¹æ³•ï¼Œå¹¶é…ç½® VM Options -Dlogging.config=classpath:logback-spring.xml -Ddruid.mysql.usePingMethod=false -Dspring.profiles.active=mysql WorkerServerï¼šåœ¨ Intellij IDEA ä¸­æ‰§è¡Œ org.apache.dolphinscheduler.server.worker.WorkerServer ä¸­çš„ main æ–¹æ³•ï¼Œå¹¶é…ç½® VM Options -Dlogging.config=classpath:logback-spring.xml -Ddruid.mysql.usePingMethod=false -Dspring.profiles.active=mysql ApiApplicationServerï¼šåœ¨ Intellij IDEA ä¸­æ‰§è¡Œ org.apache.dolphinscheduler.api.ApiApplicationServer ä¸­çš„ main æ–¹æ³•ï¼Œå¹¶é…ç½® VM Options -Dlogging.config=classpath:logback-spring.xml -Dspring.profiles.active=api,mysqlã€‚å¯åŠ¨å®Œæˆå¯ä»¥æµè§ˆ Open API æ–‡æ¡£ï¼Œåœ°å€ä¸º http://localhost:12345/dolphinscheduler/swagger-ui/index.html å‰ç«¯å®‰è£…ä¾èµ–ï¼Œè¿è¡Œå‰ç«¯æœåŠ¡123cd dolphinscheduler-uipnpm installpnpm run dev æˆªæ­¢ç›®å‰ï¼Œå‰åŽç«¯å·²æˆåŠŸè¿è¡Œèµ·æ¥ï¼Œæµè§ˆå™¨è®¿é—® http://localhost:5173 ï¼Œå¹¶ä½¿ç”¨é»˜è®¤è´¦æˆ·å¯†ç  admin/dolphinscheduler123 å³å¯å®Œæˆç™»å½• å®ŒæˆçŽ¯å¢ƒæ­å»ºæ­å»ºæˆåŠŸæ•ˆæžœ","link":"/2024/07/27/Dolphinscheduler%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"},{"title":"Flinkæºç ç¼–è¯‘","text":"å‰è¨€å­¦ä¹ ä¸€ä¸‹Flinkçš„æ‰§è¡ŒåŽŸç†ï¼Œéœ€è¦åœ¨æœ¬åœ°ç¼–è¯‘æºç å¥½debugè¿è¡Œã€‚ ç¼–è¯‘çŽ¯å¢ƒ çŽ¯å¢ƒ ç‰ˆæœ¬ ç³»ç»Ÿ m1 pro macbook pro 14 JRE Zulu 8.62.0.19-CA-macos-aarch64 Flink release-1.12.7-rc1 ç¼–è¯‘è¿‡ç¨‹1mvn clean package -DskipTests -Dhadoop.version=2.7.1 å‚è€ƒä¸‹Building Apache Flink from Source ç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿå¦‚ä¸‹å¼‚å¸¸å¹¶è§£å†³ æŠ¥é”™ï¼šå®‰è£…nodeå’Œnpmå¤±è´¥1[ERROR] Failed to execute goal com.github.eirslett:frontend-maven-plugin:1.6:install-node-and-npm (install node and npm) on project flink-runtime-web_2.11: Could not download Node.js: Could not download https://nodejs.org/dist/v10.9.0/node-v10.9.0-darwin-arm64.tar.gz: nodejs.org:443 failed to respond -&gt; [Help 1] è§£å†³æ–¹æ¡ˆï¼šå‚è€ƒeirslett/frontend-maven-plugin issue 952ï¼ŒFLINK-23230æåˆ°çš„é—®é¢˜ä¿®æ”¹flink/flink-runtime-web/pom.xmlæ–‡ä»¶ä¸­frontend-maven-pluginçš„ç‰ˆæœ¬ä¸º1.11.0ï¼Œå‘çŽ°è¿˜æ˜¯æœ‰443å¼‚å¸¸ï¼ŒåŽæ¥å‘çŽ°æ˜¯mavençš„settings.xmlä¸­é…ç½®çš„proxyèµ°çš„æ˜¯sock5ï¼Œä¿®æ”¹æˆhttpä»£ç†åŽæ¢å¤æ­£å¸¸","link":"/2022/07/03/Flink%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/"},{"title":"MySQLå®žæˆ˜45è®²-é˜…è¯»ç¬”è®°","text":"SQLæŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹å…·ä½“æ‹†è§£å¦‚ä¸‹ï¼Œ è¿žæŽ¥å™¨ é•¿è¿žæŽ¥æ˜¯æŒ‡è¿žæŽ¥æˆåŠŸåŽï¼Œå¦‚æžœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿žæŽ¥ã€‚çŸ­è¿žæŽ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿žæŽ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚ä½¿ç”¨é•¿è¿žæŽ¥å¯èƒ½ä¼šå¯¼è‡´MySQLå ç”¨å†…å­˜å¿«é€Ÿä¸Šæ¶¨ï¼ŒåŽŸå› æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿žæŽ¥å¯¹è±¡é‡Œé¢çš„ï¼Œè¿™äº›èµ„æºä¼šåœ¨è¿žæŽ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ª å®šæœŸæ–­å¼€é•¿è¿žæŽ¥ MySQL 5.7æˆ–æ›´æ–°ç‰ˆæœ¬å¯ä»¥æ‰§è¡Œmysql_reset_connectionæ¥é‡æ–°åˆå§‹åŒ–è¿žæŽ¥èµ„æº æŸ¥è¯¢ç¼“å­˜ é™¤éžæ˜¯é™æ€è¡¨ï¼Œå¦åˆ™ä¸å»ºè®®å¼€å¯æŸ¥è¯¢ç¼“å­˜ã€‚è¡¨åªè¦æœ‰ä¸€æ¬¡æ›´æ–°æ“ä½œï¼Œè¡¨å…³è”æ‰€æœ‰ç¼“å­˜éƒ½å¤±æ•ˆã€‚MySQL 8.0åŠä»¥ä¸Šç¼“å­˜åŠŸèƒ½å·²è¢«åºŸå¼ƒ åˆ†æžå™¨ï¼šä¾æ¬¡è¿›è¡Œå¦‚ä¸‹åˆ†æžï¼Œä¸ç¬¦åˆè¯æ³•æˆ–è¯­æ³•åˆ™æŠ›å‡ºå¼‚å¸¸ â‘ è¯æ³•åˆ†æžï¼šè§£æžå…³é”®å­—å’Œå­—æ®µå â‘¡è¯­æ³•åˆ†æžï¼šåˆ¤æ–­æ˜¯å¦ç¬¦åˆMySQLè¯­æ³• ä¼˜åŒ–å™¨ï¼šå†³å®šSQLçš„æ‰§è¡Œé¡ºåº æ‰§è¡Œå™¨ï¼šè¡¨æƒé™æ ¡éªŒï¼Œè°ƒç”¨æŸ¥è¯¢å¼•æ“ŽæŽ¥å£æ ¹æ®ç´¢å¼•ï¼ˆå¦‚æžœæœ‰ï¼‰æŸ¥è¯¢æ•°æ® SQLæ›´æ–°è¯­å¥çš„æ‰§è¡Œæ‰§è¡Œæµç¨‹å’ŒæŸ¥è¯¢è¯­å¥çš„æµç¨‹ä¸€æ ·ï¼Œå¦‚ä¸‹ redo logå’Œbinlogé™¤æ­¤ä»¥å¤–ï¼Œæ›´æ–°æµç¨‹è¿˜æ¶‰åŠä¸¤ä¸ªé‡è¦çš„æ—¥å¿—æ¨¡å—ï¼šredo logï¼ˆé‡åšæ—¥å¿—ï¼‰å’Œ binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ redo log - InnoDBå¼•æ“Žç‰¹æœ‰çš„æ—¥å¿—ï¼Œå¯ä»¥ä¿è¯crash-safeã€‚ - ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ã€‚ - å¾ªçŽ¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œwrite posæ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åŽç§»ï¼Œcheckpointæ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œä¹Ÿæ˜¯å¾€åŽæŽ¨ç§»å¹¶ä¸”å¾ªçŽ¯çš„ï¼Œæ“¦é™¤è®°å½•å‰è¦æŠŠè®°å½•æ›´æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚write poså’Œcheckpointä¹‹é—´çš„æ˜¯è¿˜ç©ºç€çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥è®°å½•æ–°çš„æ“ä½œã€‚å¦‚æžœwrite posè¿½ä¸Šcheckpointï¼Œè¡¨ç¤ºredologæ»¡äº†ä¸èƒ½å†æ‰§è¡Œæ–°çš„æ›´æ–°ï¼Œå¾—åœä¸‹æ¥å…ˆæ“¦æŽ‰ä¸€äº›è®°å½•å†™å…¥binlogï¼ŒæŠŠcheckpointæŽ¨è¿›ä¸€ä¸‹ã€‚ binlog - MySQLçš„Serverå±‚å®žçŽ°çš„ï¼Œæ‰€æœ‰å¼•æ“Žéƒ½å¯ä»¥ä½¿ç”¨ï¼Œç”¨äºŽå½’æ¡£ã€‚ - é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŽŸå§‹é€»è¾‘ï¼Œæ¯”å¦‚â€œç»™ID=2è¿™ä¸€è¡Œçš„cå­—æ®µåŠ 1â€ã€‚ - å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚binlogæ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åŽä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚ updateè¯­å¥çš„æ‰§è¡Œæµç¨‹updateè¯­å¥çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼Œå›¾ä¸­æµ…è‰²æ¡†è¡¨ç¤ºæ˜¯åœ¨InnoDBå†…éƒ¨æ‰§è¡Œçš„ï¼Œæ·±è‰²æ¡†è¡¨ç¤ºæ˜¯åœ¨æ‰§è¡Œå™¨ä¸­æ‰§è¡Œçš„ã€‚redo logçš„å†™å…¥æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼šprepareå’Œcommitï¼Œä¹Ÿå°±æ˜¯â€ä¸¤é˜¶æ®µæäº¤â€ã€‚ ðŸ”¥äº‹åŠ¡çš„éš”ç¦»çº§åˆ«éš”ç¦»æ€§ä¸Žéš”ç¦»çº§åˆ« table th:first-of-type {width: 25%;} table th:nth-of-type(2) {width: 75%;} çº§åˆ« å«ä¹‰ è¯»æœªæäº¤ ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ° è¯»æäº¤ ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åŽï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ° å¯é‡å¤è¯» ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ ä¸²è¡ŒåŒ– å¯¹äºŽåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºçŽ°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼ŒåŽè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ çº§åˆ« ç»“æžœ è¯»æœªæäº¤ åˆ™V1çš„å€¼å°±æ˜¯2ã€‚è¿™æ—¶å€™äº‹åŠ¡Bè™½ç„¶è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯ç»“æžœå·²ç»è¢«Açœ‹åˆ°äº†ã€‚å› æ­¤ï¼ŒV2ã€V3ä¹Ÿéƒ½æ˜¯2 è¯»æäº¤ åˆ™V1æ˜¯1ï¼ŒV2çš„å€¼æ˜¯2ã€‚äº‹åŠ¡Bçš„æ›´æ–°åœ¨æäº¤åŽæ‰èƒ½è¢«Açœ‹åˆ°ã€‚æ‰€ä»¥ï¼Œ V3çš„å€¼ä¹Ÿæ˜¯2 å¯é‡å¤è¯» åˆ™V1ã€V2æ˜¯1ï¼ŒV3æ˜¯2ã€‚ä¹‹æ‰€ä»¥V2è¿˜æ˜¯1ï¼Œéµå¾ªçš„å°±æ˜¯è¿™ä¸ªè¦æ±‚ï¼šäº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´çœ‹åˆ°çš„æ•°æ®å‰åŽå¿…é¡»æ˜¯ä¸€è‡´çš„ ä¸²è¡ŒåŒ– åˆ™åœ¨äº‹åŠ¡Bæ‰§è¡Œâ€œå°†1æ”¹æˆ2â€çš„æ—¶å€™ï¼Œä¼šè¢«é”ä½ã€‚ç›´åˆ°äº‹åŠ¡Aæäº¤åŽï¼Œäº‹åŠ¡Bæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ä»ŽAçš„è§’åº¦çœ‹ï¼Œ V1ã€V2å€¼æ˜¯1ï¼ŒV3çš„å€¼æ˜¯2 ðŸ”¥äº‹åŠ¡éš”ç¦»çš„å®žçŽ°äº‹åŠ¡éš”ç¦»å…·ä½“æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Œè¿™é‡Œä»¥â€œå¯é‡å¤è¯»â€ä¸ºä¾‹å±•å¼€è¯´æ˜Žä¸€ä¸‹ã€‚ åœ¨MySQLä¸­ï¼Œå®žé™…ä¸Šæ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›žæ»šæ“ä½œã€‚è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œé€šè¿‡å›žæ»šæ“ä½œï¼Œéƒ½å¯ä»¥å¾—åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚å‡è®¾ä¸€ä¸ªå€¼ä»Ž1è¢«æŒ‰é¡ºåºæ”¹æˆäº†2ã€3ã€4ï¼Œåœ¨å›žæ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚ å½“å‰å€¼æ˜¯4ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢è¿™æ¡è®°å½•çš„æ—¶å€™ï¼Œä¸åŒæ—¶åˆ»å¯åŠ¨çš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„read-view.å¦‚å›¾ä¸­çœ‹åˆ°çš„ï¼Œåœ¨è§†å›¾Aã€Bã€Cé‡Œé¢ï¼Œè¿™ä¸€ä¸ªè®°å½•çš„å€¼åˆ†åˆ«æ˜¯1ã€2ã€4ï¼ŒåŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼ˆMVCCï¼‰ã€‚å¯¹äºŽread-view Aï¼Œè¦å¾—åˆ°1ï¼Œå°±å¿…é¡»å°†å½“å‰å€¼ä¾æ¬¡æ‰§è¡Œå›¾ä¸­æ‰€æœ‰çš„å›žæ»šæ“ä½œå¾—åˆ°ã€‚å›žæ»šæ—¥å¿—ä¸ä¼šä¸€ç›´ä¿ç•™ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™æ‰åˆ é™¤ã€‚ä»€ä¹ˆæ—¶å€™æ‰ä¸éœ€è¦äº†å‘¢ï¼Ÿå°±æ˜¯å½“ç³»ç»Ÿé‡Œæ²¡æœ‰æ¯”è¿™ä¸ªå›žæ»šæ—¥å¿—æ›´æ—©çš„read-viewçš„æ—¶å€™ã€‚æ‰€ä»¥ä¸å»ºè®®ç”¨é•¿äº‹åŠ¡ï¼Œé•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ï¼Œå› æ­¤å›žæ»šæ—¥å¿—ä¼šå ç”¨å¤§é‡å­˜å‚¨èµ„æºï¼Œè¿˜å ç”¨é”èµ„æºï¼Œä¹Ÿå¯èƒ½æ‹–åž®æ•´ä¸ªåº“ã€‚ æ·±å…¥æµ…å‡ºç´¢å¼•ç´¢å¼•çš„æ•°æ®ç»“æž„å“ˆå¸Œè¡¨ï¼šé€‚ç”¨äºŽåªæœ‰ç­‰å€¼æŸ¥è¯¢çš„åœºæ™¯ æœ‰åºæ•°ç»„ï¼šåœ¨ç­‰å€¼æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢åœºæ™¯ä¸­çš„æ€§èƒ½å°±éƒ½éžå¸¸ä¼˜ç§€ã€‚ä½†æ˜¯æ’å…¥æ•ˆçŽ‡è¾ƒä½Žï¼Œåªé€‚ç”¨äºŽé™æ€å­˜å‚¨å¼•æ“Ž æœç´¢æ ‘ï¼šä½¿ç”¨Nå‰æœç´¢æ ‘ ä¸ºä»€ä¹ˆä¸ä½¿ç”¨äºŒå‰æœç´¢æ ‘ï¼šç´¢å¼•æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ŒäºŒå‰æœç´¢æ ‘èŠ‚ç‚¹åªå­˜å‚¨ä¸€ä¸ªæ•°æ®ï¼Œæ ‘æ¯”è¾ƒé«˜ï¼Œä¸€æ¬¡æŸ¥è¯¢éœ€è¦æ›´å¤šæ¬¡çš„æ•°æ®å—è¯»å– InnoDB çš„ç´¢å¼•æ¨¡åž‹åœ¨InnoDBä¸­ï¼Œè¡¨éƒ½æ˜¯æ ¹æ®ä¸»é”®é¡ºåºä»¥ç´¢å¼•çš„å½¢å¼å­˜æ”¾çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼çš„è¡¨ç§°ä¸ºç´¢å¼•ç»„ç»‡è¡¨ã€‚InnoDBä½¿ç”¨äº†B+æ ‘ç´¢å¼•æ¨¡åž‹ï¼Œæ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨B+æ ‘ä¸­ã€‚ æ¯ä¸€ä¸ªç´¢å¼•åœ¨InnoDBé‡Œé¢å¯¹åº”ä¸€æ£µB+æ ‘ã€‚ä»¥å¦‚ä¸‹çš„å»ºè¡¨è¯­å¥ä¸ºä¾‹ï¼Œç´¢å¼•æ ‘ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤º 12345create table T( id int primary key, k int not null, name varchar(16),index (k))engine=InnoDB; ä¸»é”®ç´¢å¼•ï¼šä¹Ÿå«èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜çš„æ˜¯æ•´è¡Œæ•°æ®æ™®é€šç´¢å¼•ï¼šä¹Ÿå«äºŒçº§ç´¢å¼•ï¼Œéžèšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å†…å®¹æ˜¯ä¸»é”®çš„å€¼ Qï¼šåŸºäºŽä¸»é”®ç´¢å¼•å’Œæ™®é€šç´¢å¼•çš„æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸAï¼šä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢ä¸»é”®è¿™æ£µB+æ ‘ã€‚æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢æ™®é€šç´¢å¼•æ ‘ï¼Œå¾—åˆ°å¶èŠ‚ç‚¹ä¸Šçš„ä¸»é”®å€¼ï¼Œå†åˆ°ä¸»é”®ç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›žè¡¨ ç´¢å¼•ç»´æŠ¤B+æ ‘ä¸ºäº†ç»´æŠ¤ç´¢å¼•æœ‰åºæ€§ï¼Œåœ¨æ’å…¥æ–°å€¼çš„æ—¶å€™éœ€è¦åšå¿…è¦çš„ç»´æŠ¤ã€‚ å¦‚æžœæ’å…¥ä¸€ä¸ªæ›´å¤§çš„å€¼ï¼Œåªéœ€è¦åœ¨æœ€åŽé¢æ’å…¥ä¸€ä¸ªæ–°è®°å½•ã€‚ å¦‚æžœåœ¨ä¸­é—´æ’å…¥ä¸€ä¸ªå€¼ï¼Œå¤„ç†æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦é€»è¾‘ä¸ŠæŒªåŠ¨åŽé¢çš„æ•°æ®ï¼Œç©ºå‡ºä½ç½®ã€‚ è€Œæ›´ç³Ÿçš„æƒ…å†µæ˜¯ï¼Œå¦‚æžœæ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œæ ¹æ®B+æ ‘çš„ç®—æ³•ï¼Œéœ€è¦ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°æ®é¡µï¼Œç„¶åŽæŒªåŠ¨éƒ¨åˆ†æ•°æ®è¿‡åŽ»ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºé¡µåˆ†è£‚ï¼Œæ’å…¥æ€§èƒ½å› æ­¤ä¼šå—åˆ°å½±å“ã€‚é™¤äº†æ€§èƒ½å¤–ï¼Œé¡µåˆ†è£‚æ“ä½œè¿˜å½±å“æ•°æ®é¡µçš„åˆ©ç”¨çŽ‡ã€‚åŽŸæœ¬æ”¾åœ¨ä¸€ä¸ªé¡µçš„æ•°æ®ï¼ŒçŽ°åœ¨åˆ†åˆ°ä¸¤ä¸ªé¡µä¸­ï¼Œæ•´ä½“ç©ºé—´åˆ©ç”¨çŽ‡é™ä½Žå¤§çº¦50%ã€‚å½“ç„¶æœ‰åˆ†è£‚å°±æœ‰åˆå¹¶ã€‚å½“ç›¸é‚»ä¸¤ä¸ªé¡µç”±äºŽåˆ é™¤äº†æ•°æ®ï¼Œåˆ©ç”¨çŽ‡å¾ˆä½Žä¹‹åŽï¼Œä¼šå°†æ•°æ®é¡µåšåˆå¹¶ã€‚åˆå¹¶çš„è¿‡ç¨‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯åˆ†è£‚è¿‡ç¨‹çš„é€†è¿‡ç¨‹ã€‚ Qï¼šå“ªäº›åœºæ™¯ä¸‹åº”è¯¥ä½¿ç”¨è‡ªå¢žä¸»é”®ï¼Œè€Œå“ªäº›åœºæ™¯ä¸‹ä¸åº”è¯¥?Aï¼š è‡ªå¢žä¸»é”®çš„æ’å…¥æ•°æ®æ¨¡å¼ï¼Œæ­£ç¬¦åˆé€’å¢žæ’å…¥çš„åœºæ™¯ã€‚æ¯æ¬¡æ’å…¥ä¸€æ¡æ–°è®°å½•éƒ½æ˜¯è¿½åŠ æ“ä½œï¼Œéƒ½ä¸æ¶‰åŠåˆ°æŒªåŠ¨å…¶ä»–è®°å½•ï¼Œä¹Ÿä¸ä¼šè§¦å‘å¶å­èŠ‚ç‚¹çš„åˆ†è£‚ã€‚è€Œæœ‰ä¸šåŠ¡é€»è¾‘çš„å­—æ®µåšä¸»é”®ï¼Œåˆ™å¾€å¾€ä¸å®¹æ˜“ä¿è¯æœ‰åºæ’å…¥ï¼Œè¿™æ ·å†™æ•°æ®æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚å…¶æ¬¡ï¼Œåœ¨è€ƒè™‘ä¸»é”®å­—æ®µçš„é€‰æ‹©æ—¶ï¼Œç”±äºŽæ™®é€šç´¢å¼•çš„å¶èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®ï¼Œå› æ­¤ä¸»é”®è¶Šå°æ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´å°±æ›´å°ã€‚æ‰€ä»¥ï¼Œä»Žæ€§èƒ½å’Œå­˜å‚¨ç©ºé—´æ–¹é¢è€ƒé‡ï¼Œè‡ªå¢žä¸»é”®å¾€å¾€æ˜¯æ›´åˆç†çš„é€‰æ‹©ã€‚ è¦†ç›–ç´¢å¼•åœ¨æ™®é€šç´¢å¼•ä¸Šï¼Œå¶èŠ‚ç‚¹ä¸Šå­˜å‚¨äº†ç›¸å…³å­—æ®µå’Œä¸»é”®çš„æ•°æ®ï¼Œå¦‚æžœæŸ¥è¯¢çš„æ˜¯è¿™éƒ¨åˆ†å­—æ®µå¯ä»¥é¿å…å›žè¡¨æŸ¥è¯¢ï¼Œæé«˜æŸ¥è¯¢æ•ˆçŽ‡ï¼Œå‡å°‘æ ‘çš„æœç´¢æ¬¡æ•°ï¼Œæ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ æœ€å·¦å‰ç¼€åŽŸåˆ™B+æ ‘è¿™ç§ç´¢å¼•ç»“æž„ï¼Œå¯ä»¥åˆ©ç”¨ç´¢å¼•çš„â€œæœ€å·¦å‰ç¼€â€ï¼Œæ¥å®šä½è®°å½•ã€‚ä¸åªæ˜¯ç´¢å¼•çš„å…¨éƒ¨å®šä¹‰ï¼Œåªè¦æ»¡è¶³æœ€å·¦å‰ç¼€ï¼Œå°±å¯ä»¥åˆ©ç”¨ç´¢å¼•æ¥åŠ é€Ÿæ£€ç´¢ã€‚è¿™ä¸ªæœ€å·¦å‰ç¼€å¯ä»¥æ˜¯è”åˆç´¢å¼•çš„æœ€å·¦Nä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ç´¢å¼•çš„æœ€å·¦Mä¸ªå­—ç¬¦ã€‚ Qï¼šåœ¨å»ºç«‹è”åˆç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚ä½•å®‰æŽ’ç´¢å¼•å†…çš„å­—æ®µé¡ºåºï¼ŸAï¼š ç¬¬ä¸€åŽŸåˆ™æ˜¯ï¼Œå¦‚æžœé€šè¿‡è°ƒæ•´é¡ºåºï¼Œå¯ä»¥å°‘ç»´æŠ¤ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªé¡ºåºå¾€å¾€å°±æ˜¯éœ€è¦ä¼˜å…ˆè€ƒè™‘é‡‡ç”¨çš„ã€‚å¦‚æžœæ—¢æœ‰è”åˆæŸ¥è¯¢ï¼Œåˆæœ‰åŸºäºŽaã€bå„è‡ªçš„æŸ¥è¯¢å‘¢ï¼Ÿè¿™æ—¶å€™éœ€è¦åŒæ—¶ç»´æŠ¤ç±»ä¼¼(a,b)ã€(b) è¿™ä¸¤ä¸ªç´¢å¼•ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„åŽŸåˆ™å°±æ˜¯ç©ºé—´ï¼Œæ¯”å¦‚ä¸Šæœ‰ä¸¤ä¸ªå­—æ®µnameã€ageï¼Œnameå­—æ®µæ˜¯æ¯”ageå­—æ®µå¤§çš„ ï¼Œé‚£æˆ‘å°±å»ºè®®ä½ åˆ›å»ºä¸€ä¸ªï¼ˆname,age)çš„è”åˆç´¢å¼•å’Œä¸€ä¸ª(age)çš„å•å­—æ®µç´¢å¼•ã€‚ ç´¢å¼•ä¸‹æŽ¨ä¸¾ä¾‹ï¼Œæ¯”å¦‚è¡¨å­˜åœ¨nameã€ageçš„è”åˆç´¢å¼•ï¼Œåœ¨æ‰§è¡Œå¦‚ä¸‹è¯­å¥æ—¶ï¼Œ 1select * from tuser where name like 'å¼ %' and age=10 and ismale=1; å¦‚æžœæ²¡æœ‰ç´¢å¼•ä¸‹æŽ¨ï¼Œä¼šå›žè¡¨ä¾æ¬¡æŸ¥è¯¢è®°å½•çš„ageã€ismaleæ˜¯å¦ç¬¦åˆè¦æ±‚ å¦‚æžœå­˜åœ¨ç´¢å¼•ä¸‹æŽ¨ï¼ˆMySQL5.6å¼•å…¥ï¼‰ï¼Œä¼šå…ˆæ ¹æ®ç´¢å¼•ä¸Šçš„æ•°æ®å¯¹ageè¿›è¡Œè¿‡æ»¤ï¼Œå†å›žè¡¨æŸ¥è¯¢è®°å½•çš„ismaleæ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œè¿™æ ·çš„å›žè¡¨æ¬¡æ•°ä¼šæ›´å°‘ ðŸ”¥é”æœºåˆ¶æ ¹æ®åŠ é”çš„èŒƒå›´ï¼ŒMySQLé‡Œé¢çš„é”å¤§è‡´å¯ä»¥åˆ†æˆå…¨å±€é”ã€è¡¨çº§é”å’Œè¡Œé”ä¸‰ç±»ã€‚ å…¨å±€é”é¡¾åæ€ä¹‰ï¼Œå…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®žä¾‹åŠ é”ã€‚MySQLæä¾›äº†ä¸€ä¸ªåŠ å…¨å±€è¯»é”çš„æ–¹æ³•ï¼Œå‘½ä»¤æ˜¯ Flush tables with read lock (FTWRL)ã€‚å½“ä½ éœ€è¦è®©æ•´ä¸ªåº“å¤„äºŽåªè¯»çŠ¶æ€çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä¹‹åŽå…¶ä»–çº¿ç¨‹çš„ä»¥ä¸‹è¯­å¥ä¼šè¢«é˜»å¡žï¼šæ•°æ®æ›´æ–°è¯­å¥ï¼ˆæ•°æ®çš„å¢žåˆ æ”¹ï¼‰ã€æ•°æ®å®šä¹‰è¯­å¥ï¼ˆåŒ…æ‹¬å»ºè¡¨ã€ä¿®æ”¹è¡¨ç»“æž„ç­‰ï¼‰å’Œæ›´æ–°ç±»äº‹åŠ¡çš„æäº¤è¯­å¥ã€‚ å…¨å±€é”çš„å…¸åž‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œåšå…¨åº“é€»è¾‘å¤‡ä»½ã€‚ å¦‚æžœåº“ä¸‹çš„è¡¨éƒ½æ˜¯InnoDBè¡¨ï¼Œåœ¨ä½¿ç”¨é€»è¾‘å¤‡ä»½å·¥å…·mysqldumpæ—¶å¯ä»¥ä½¿ç”¨å‚æ•°â€“single-transactionçš„æ—¶å€™ï¼Œå¯¼æ•°æ®ä¹‹å‰å°±ä¼šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œæ¥ç¡®ä¿æ‹¿åˆ°ä¸€è‡´æ€§è§†å›¾ã€‚è€Œç”±äºŽMVCCçš„æ”¯æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯å¯ä»¥æ­£å¸¸æ›´æ–°çš„ã€‚ è¡¨çº§é”MySQLé‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯è¡¨é”ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDLï¼‰ã€‚è¡¨é”çš„è¯­æ³•æ˜¯ lock tables â€¦ read/writeã€‚ä¸ŽFTWRLç±»ä¼¼ï¼Œå¯ä»¥ç”¨unlock tablesä¸»åŠ¨é‡Šæ”¾é”ï¼Œä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æ–­å¼€çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾ã€‚éœ€è¦æ³¨æ„ï¼Œlock tablesè¯­æ³•é™¤äº†ä¼šé™åˆ¶åˆ«çš„çº¿ç¨‹çš„è¯»å†™å¤–ï¼Œä¹Ÿé™å®šäº†æœ¬çº¿ç¨‹æŽ¥ä¸‹æ¥çš„æ“ä½œå¯¹è±¡ã€‚ ä¸¾ä¸ªä¾‹å­, å¦‚æžœåœ¨æŸä¸ªçº¿ç¨‹Aä¸­æ‰§è¡Œlock tables t1 read, t2 write; è¿™ä¸ªè¯­å¥ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å†™t1ã€è¯»å†™t2çš„è¯­å¥éƒ½ä¼šè¢«é˜»å¡žã€‚åŒæ—¶ï¼Œçº¿ç¨‹Aåœ¨æ‰§è¡Œunlock tablesä¹‹å‰ï¼Œä¹Ÿåªèƒ½æ‰§è¡Œè¯»t1ã€è¯»å†™t2çš„æ“ä½œã€‚è¿žå†™t1éƒ½ä¸å…è®¸ï¼Œè‡ªç„¶ä¹Ÿä¸èƒ½è®¿é—®å…¶ä»–è¡¨ã€‚ åœ¨è¿˜æ²¡æœ‰å‡ºçŽ°æ›´ç»†ç²’åº¦çš„é”çš„æ—¶å€™ï¼Œè¡¨é”æ˜¯æœ€å¸¸ç”¨çš„å¤„ç†å¹¶å‘çš„æ–¹å¼ã€‚è€Œå¯¹äºŽInnoDBè¿™ç§æ”¯æŒè¡Œé”çš„å¼•æ“Žï¼Œä¸€èˆ¬ä¸ä½¿ç”¨lock tableså‘½ä»¤æ¥æŽ§åˆ¶å¹¶å‘ï¼Œæ¯•ç«Ÿé”ä½æ•´ä¸ªè¡¨çš„å½±å“é¢è¿˜æ˜¯å¤ªå¤§ã€‚ å¦ä¸€ç±»è¡¨çº§çš„é”æ˜¯MDLï¼ˆmetadata lockï¼‰ã€‚MDLä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚MDLçš„ä½œç”¨æ˜¯ï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœä¸€ä¸ªæŸ¥è¯¢æ­£åœ¨éåŽ†ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè€Œæ‰§è¡ŒæœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æž„åšå˜æ›´ï¼Œåˆ äº†ä¸€åˆ—ï¼Œé‚£ä¹ˆæŸ¥è¯¢çº¿ç¨‹æ‹¿åˆ°çš„ç»“æžœè·Ÿè¡¨ç»“æž„å¯¹ä¸ä¸Šï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚ å› æ­¤ï¼Œåœ¨MySQL 5.5ç‰ˆæœ¬ä¸­å¼•å…¥äº†MDLï¼Œå½“å¯¹ä¸€ä¸ªè¡¨åšå¢žåˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æž„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”ã€‚ è¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œå› æ­¤ä½ å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€å¼ è¡¨å¢žåˆ æ”¹æŸ¥ã€‚ è¯»å†™é”ä¹‹é—´ã€å†™é”ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œç”¨æ¥ä¿è¯å˜æ›´è¡¨ç»“æž„æ“ä½œçš„å®‰å…¨æ€§ã€‚å› æ­¤ï¼Œå¦‚æžœæœ‰ä¸¤ä¸ªçº¿ç¨‹è¦åŒæ—¶ç»™ä¸€ä¸ªè¡¨åŠ å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªè¦ç­‰å¦ä¸€ä¸ªæ‰§è¡Œå®Œæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚ Qï¼šä¸ºä»€ä¹ˆä¿®æ”¹è¡¨ç»“æž„æ“ä½œå¯èƒ½å‡ºçŽ°é—®é¢˜ï¼ŸAï¼š å¦‚æžœè¡¨æ­£åœ¨è¢«è¯»ï¼Œä¸€äº›sessionå› æ­¤èŽ·å–äº†è¯»é”ï¼Œåœ¨è¿›è¡Œä¿®æ”¹è¡¨ç»“æž„æ“ä½œèŽ·å–å†™é”çš„æ—¶å€™å°±ä¼šé˜»å¡žä½ï¼Œæ­¤æ—¶å¦‚æžœå†å‘ç”Ÿå…¶ä»–ç”³è¯·è¯»é”çš„sessionï¼Œè¿™äº›sessionä¹Ÿä¼šå…¨éƒ¨è¢«é˜»å¡žä½ã€‚å¦‚æžœæŸä¸ªè¡¨ä¸Šçš„æŸ¥è¯¢è¯­å¥é¢‘ç¹ï¼Œè€Œä¸”å®¢æˆ·ç«¯æœ‰é‡è¯•æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¶…æ—¶åŽä¼šå†èµ·ä¸€ä¸ªæ–°sessionå†è¯·æ±‚çš„è¯ï¼Œè¿™ä¸ªåº“çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚ Qï¼šå¦‚ä½•å®‰å…¨åœ°ç»™å°è¡¨åŠ å­—æ®µï¼ŸAï¼š é¦–å…ˆæˆ‘ä»¬è¦è§£å†³é•¿äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸æäº¤ï¼Œå°±ä¼šä¸€ç›´å ç€MDLé”ã€‚åœ¨MySQLçš„information_schema åº“çš„ innodb_trx è¡¨ä¸­ï¼Œä½ å¯ä»¥æŸ¥åˆ°å½“å‰æ‰§è¡Œä¸­çš„äº‹åŠ¡ã€‚å¦‚æžœä½ è¦åšDDLå˜æ›´çš„è¡¨åˆšå¥½æœ‰é•¿äº‹åŠ¡åœ¨æ‰§è¡Œï¼Œè¦è€ƒè™‘å…ˆæš‚åœDDLï¼Œæˆ–è€…killæŽ‰è¿™ä¸ªé•¿äº‹åŠ¡ã€‚å¦‚æžœè¦å˜æ›´çš„è¡¨æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¡¨ï¼Œè™½ç„¶æ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯ä¸Šé¢çš„è¯·æ±‚å¾ˆé¢‘ç¹ï¼Œè¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿä¸ºalter tableæ“ä½œå¢žåŠ è¶…æ—¶ ðŸ”¥è¡Œé”MySQLçš„è¡Œé”æ˜¯åœ¨å¼•æ“Žå±‚ç”±å„ä¸ªå¼•æ“Žè‡ªå·±å®žçŽ°çš„ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“Žéƒ½æ”¯æŒè¡Œé”ï¼Œæ¯”å¦‚MyISAMå¼•æ“Žå°±ä¸æ”¯æŒè¡Œé”ã€‚ä¸æ”¯æŒè¡Œé”æ„å‘³ç€å¹¶å‘æŽ§åˆ¶åªèƒ½ä½¿ç”¨è¡¨é”ï¼Œè¿™å°±ä¼šå½±å“åˆ°ä¸šåŠ¡å¹¶å‘åº¦ã€‚InnoDBæ˜¯æ”¯æŒè¡Œé”çš„ï¼Œè¿™ä¹Ÿæ˜¯MyISAMè¢«InnoDBæ›¿ä»£çš„é‡è¦åŽŸå› ä¹‹ä¸€ã€‚ ðŸ”¥ä¸¤é˜¶æ®µé”åè®®åœ¨ä¸‹é¢çš„æ“ä½œåºåˆ—ä¸­ï¼Œäº‹åŠ¡Bçš„updateè¯­å¥æ‰§è¡Œæ—¶ä¼šæ˜¯ä»€ä¹ˆçŽ°è±¡å‘¢ï¼Ÿå‡è®¾å­—æ®µidæ˜¯è¡¨tçš„ä¸»é”®ã€‚ç»“æžœå–å†³äºŽäº‹åŠ¡Aåœ¨æ‰§è¡Œå®Œä¸¤æ¡updateè¯­å¥åŽï¼ŒæŒæœ‰å“ªäº›é”ï¼Œä»¥åŠåœ¨ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ã€‚ å®žé™…ä¸Šäº‹åŠ¡Bçš„updateè¯­å¥ä¼šè¢«é˜»å¡žï¼Œç›´åˆ°äº‹åŠ¡Aæ‰§è¡Œcommitä¹‹åŽï¼Œäº‹åŠ¡Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚å› æ­¤äº‹åŠ¡AæŒæœ‰çš„ä¸¤ä¸ªè®°å½•çš„è¡Œé”ï¼Œéƒ½æ˜¯åœ¨commitçš„æ—¶å€™æ‰é‡Šæ”¾çš„ã€‚ åœ¨InnoDBäº‹åŠ¡ä¸­ï¼Œè¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹åˆ»é‡Šæ”¾ï¼Œè€Œæ˜¯è¦ç­‰åˆ°äº‹åŠ¡ç»“æŸæ—¶æ‰é‡Šæ”¾ã€‚è¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚ çŸ¥é“äº†è¿™ä¸ªè®¾å®šï¼Œå¯¹æˆ‘ä»¬ä½¿ç”¨äº‹åŠ¡æœ‰ä»€ä¹ˆå¸®åŠ©å‘¢ï¼Ÿé‚£å°±æ˜¯ï¼Œå¦‚æžœä½ çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠæœ€å¯èƒ½é€ æˆé”å†²çªã€æœ€å¯èƒ½å½±å“å¹¶å‘åº¦çš„é”å°½é‡å¾€åŽæ”¾ã€‚è¿™æ ·æ“ä½œå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°å‡å°‘äº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…ï¼Œæå‡å¹¶å‘åº¦ã€‚ æ­»é”å’Œæ­»é”æ£€æµ‹å½“å¹¶å‘ç³»ç»Ÿä¸­ä¸åŒçº¿ç¨‹å‡ºçŽ°å¾ªçŽ¯èµ„æºä¾èµ–ï¼Œæ¶‰åŠçš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…åˆ«çš„çº¿ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼Œå°±ä¼šå¯¼è‡´è¿™å‡ ä¸ªçº¿ç¨‹éƒ½è¿›å…¥æ— é™ç­‰å¾…çš„çŠ¶æ€ï¼Œç§°ä¸ºæ­»é”ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œäº‹åŠ¡Aåœ¨ç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾id=2çš„è¡Œé”ï¼Œè€Œäº‹åŠ¡Båœ¨ç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾id=1çš„è¡Œé”ã€‚ äº‹åŠ¡Aå’Œäº‹åŠ¡Båœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„èµ„æºé‡Šæ”¾ï¼Œå°±æ˜¯è¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚ å‡ºçŽ°æ­»é”ä»¥åŽï¼Œæœ‰ä¸¤ç§ç­–ç•¥ï¼š ä¸€ç§ç­–ç•¥æ˜¯ï¼Œç›´æŽ¥è¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ã€‚è¿™ä¸ªè¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å‚æ•°innodb_lock_wait_timeoutæ¥è®¾ç½®ã€‚ å¦ä¸€ç§ç­–ç•¥æ˜¯ï¼Œå‘èµ·æ­»é”æ£€æµ‹ï¼Œå‘çŽ°æ­»é”åŽï¼Œä¸»åŠ¨å›žæ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚å°†å‚æ•°innodb_deadlock_detectè®¾ç½®ä¸ºonï¼Œè¡¨ç¤ºå¼€å¯è¿™ä¸ªé€»è¾‘ã€‚ åœ¨InnoDBä¸­ï¼Œinnodb_lock_wait_timeoutçš„é»˜è®¤å€¼æ˜¯50sï¼Œå¯¹äºŽåœ¨çº¿æœåŠ¡æ¥è¯´ä¸€èˆ¬æ˜¯æ— æ³•æŽ¥å—çš„ã€‚ä½†æ˜¯ä¸èƒ½æŠŠè¿™ä¸ªå€¼è®¾å¾—å¾ˆå°ï¼Œå› ä¸ºæ­£å¸¸çš„é”ç­‰å¾…ä¹Ÿæœ‰å¯èƒ½è¢«é”™è¯¯åœ°é‡Šæ”¾ã€‚æ‰€ä»¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬è¿˜æ˜¯è¦é‡‡ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼Œå³ï¼šä¸»åŠ¨æ­»é”æ£€æµ‹ï¼Œä½†æ˜¯æ¯ä¸ªæ–°çš„è¢«å µä½çš„çº¿ç¨‹ï¼Œéƒ½è¦åˆ¤æ–­ä¼šä¸ä¼šç”±äºŽè‡ªå·±çš„åŠ å…¥å¯¼è‡´äº†æ­»é”ï¼Œè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦æ˜¯O(n)çš„æ“ä½œã€‚å‡è®¾æœ‰1000ä¸ªå¹¶å‘çº¿ç¨‹è¦åŒæ—¶æ›´æ–°åŒä¸€è¡Œï¼Œé‚£ä¹ˆæ­»é”æ£€æµ‹æ“ä½œå°±æ˜¯100ä¸‡è¿™ä¸ªé‡çº§çš„ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„CPUèµ„æºã€‚ æ€Žä¹ˆè§£å†³ç”±è¿™ç§çƒ­ç‚¹è¡Œæ›´æ–°ï¼Œå¯¼è‡´çš„æ­»é”æ£€æµ‹è€—è´¹å¤§é‡CPUèµ„æºçš„é—®é¢˜å‘¢ï¼Ÿ å¦‚æžœä½ èƒ½ç¡®ä¿è¿™ä¸ªä¸šåŠ¡ä¸€å®šä¸ä¼šå‡ºçŽ°æ­»é”ï¼Œå¯ä»¥ä¸´æ—¶æŠŠæ­»é”æ£€æµ‹å…³æŽ‰ã€‚ä½†æ˜¯å¤§éƒ¨åˆ†ä¸šåŠ¡è®¾è®¡æ—¶ä¸ä¼šæŠŠæ­»é”å½“åšä¸€ä¸ªä¸¥é‡é”™è¯¯ï¼Œé‡åˆ°å¼‚å¸¸ä¸šåŠ¡é‡è¯•å°±å®Œäº†ï¼Œå¦‚æžœé”ç­‰å¾…è¶…æ—¶çš„è¯å¯¹ä¸šåŠ¡æ¥è¯´æ˜¯æœ‰æŸçš„ã€‚ æŽ§åˆ¶å¹¶å‘åº¦ï¼Œåœ¨æ•°æ®åº“æœåŠ¡ç«¯å¯¹äºŽç›¸åŒè¡Œçš„æ›´æ–°ï¼Œåœ¨è¿›å…¥å¼•æ“Žä¹‹å‰æŽ’é˜Ÿã€‚è¿™æ ·åœ¨InnoDBå†…éƒ¨å°±ä¸ä¼šæœ‰å¤§é‡çš„æ­»é”æ£€æµ‹å·¥ä½œäº†ã€‚å¦‚æžœæ•°æ®åº“å±‚é¢æ²¡æœ‰å›¢é˜Ÿæ”¯æŒï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å°†ä¸€è¡Œæ”¹æˆé€»è¾‘ä¸Šçš„å¤šè¡Œæ¥å‡å°‘é”å†²çªã€‚ ðŸ”¥äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŽŸç†åœ¨ç¬¬3ç« ä¸­æ›¾ç»æåˆ°è¿‡ï¼Œå¦‚æžœæ˜¯å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡Tå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾read-viewï¼Œä¹‹åŽäº‹åŠ¡Tæ‰§è¡ŒæœŸé—´ï¼Œå³ä½¿æœ‰å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œäº‹åŠ¡Tçœ‹åˆ°çš„ä»ç„¶è·Ÿåœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„ä¸€æ ·ã€‚ ä½†æ˜¯ï¼Œåœ¨ç¬¬4ç« ä¸­ï¼Œå…³äºŽè¡Œé”çš„æè¿°æ—¶åˆæåˆ°ï¼Œä¸€ä¸ªäº‹åŠ¡è¦æ›´æ–°ä¸€è¡Œï¼Œå¦‚æžœåˆšå¥½æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ‹¥æœ‰è¿™ä¸€è¡Œçš„è¡Œé”ï¼Œå®ƒåˆä¼šè¢«é”ä½ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚é—®é¢˜æ˜¯ï¼Œæ—¢ç„¶è¿›å…¥äº†ç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆç­‰åˆ°è¿™ä¸ªäº‹åŠ¡è‡ªå·±èŽ·å–åˆ°è¡Œé”è¦æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œå®ƒè¯»åˆ°çš„å€¼åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä»¥å¦‚ä¸‹è¿™ä¸ªè¡¨ä¸ºä¾‹ï¼Œ 123456mysql&gt; CREATE TABLE `t` ( `id` int(11) NOT NULL, `k` int(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB;insert into t(id, k) values(1,1),(2,2); å…³äºŽäº‹åŠ¡çš„å¯åŠ¨æ—¶æœºï¼Œbegin/start transaction å‘½ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼Œåœ¨æ‰§è¡Œåˆ°å®ƒä»¬ä¹‹åŽçš„ç¬¬ä¸€ä¸ªæ“ä½œInnoDBè¡¨çš„è¯­å¥ï¼Œäº‹åŠ¡æ‰çœŸæ­£å¯åŠ¨ã€‚å¦‚æžœä½ æƒ³è¦é©¬ä¸Šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨start transaction with consistent snapshot è¿™ä¸ªå‘½ä»¤ã€‚åœ¨æœ¬ç¬”è®°ä¸­ï¼Œå¦‚æžœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜Žï¼Œéƒ½æ˜¯é»˜è®¤autocommit=1ã€‚ ä»¤äººæƒŠè®¶åœ°ï¼Œç»“æžœæ˜¯äº‹åŠ¡BæŸ¥åˆ°çš„kçš„å€¼æ˜¯3ï¼Œè€Œäº‹åŠ¡AæŸ¥åˆ°çš„kçš„å€¼æ˜¯1ï¼Œå…·ä½“åŽŸå› ä¼šåœ¨åŽé¢ä»‹ç»ã€‚ åœ¨MySQLé‡Œï¼Œæœ‰ä¸¤ä¸ªâ€œè§†å›¾â€çš„æ¦‚å¿µï¼š ä¸€ä¸ªæ˜¯viewã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨æŸ¥è¯¢è¯­å¥å®šä¹‰çš„è™šæ‹Ÿè¡¨ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶ç”Ÿæˆç»“æžœã€‚åˆ›å»ºè§†å›¾çš„è¯­æ³•æ˜¯create view â€¦ ï¼Œè€Œå®ƒçš„æŸ¥è¯¢æ–¹æ³•ä¸Žè¡¨ä¸€æ ·ã€‚ å¦ä¸€ä¸ªæ˜¯InnoDBåœ¨å®žçŽ°MVCCæ—¶ç”¨åˆ°çš„ä¸€è‡´æ€§è¯»è§†å›¾ï¼Œå³consistent read viewï¼Œç”¨äºŽæ”¯æŒRCï¼ˆRead Committedï¼Œè¯»æäº¤ï¼‰å’ŒRRï¼ˆRepeatable Readï¼Œå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«çš„å®žçŽ° ðŸ”¥MVCCæ˜¯å¦‚ä½•æä¾›â€œå¿«ç…§â€çš„InnoDBé‡Œé¢æ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œå«ä½œtransaction idã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢žçš„ã€‚ è€Œæ¯è¡Œæ•°æ®ä¹Ÿéƒ½æ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬çš„ã€‚æ¯æ¬¡äº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œå¹¶ä¸”æŠŠtransaction idèµ‹å€¼ç»™è¿™ä¸ªæ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡IDï¼Œè®°ä¸ºrow trx_idã€‚åŒæ—¶ï¼Œæ—§çš„æ•°æ®ç‰ˆæœ¬è¦ä¿ç•™ï¼Œå¹¶ä¸”åœ¨æ–°çš„æ•°æ®ç‰ˆæœ¬ä¸­ï¼Œèƒ½å¤Ÿæœ‰ä¿¡æ¯å¯ä»¥ç›´æŽ¥æ‹¿åˆ°å®ƒã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°æ®è¡¨ä¸­çš„ä¸€è¡Œè®°å½•ï¼Œå…¶å®žå¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬(row)ï¼Œæ¯ä¸ªç‰ˆæœ¬æœ‰è‡ªå·±çš„row trx_idã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°±æ˜¯ä¸€ä¸ªè®°å½•è¢«å¤šä¸ªäº‹åŠ¡è¿žç»­æ›´æ–°åŽçš„çŠ¶æ€ã€‚ å›¾ä¸­è™šçº¿æ¡†é‡Œæ˜¯åŒä¸€è¡Œæ•°æ®çš„4ä¸ªç‰ˆæœ¬ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯V4ï¼Œkçš„å€¼æ˜¯22ï¼Œå®ƒæ˜¯è¢«transaction id ä¸º25çš„äº‹åŠ¡æ›´æ–°çš„ï¼Œå› æ­¤å®ƒçš„row trx_idä¹Ÿæ˜¯25ã€‚ å›¾ä¸­çš„ä¸‰ä¸ªè™šçº¿ç®­å¤´ï¼Œå°±æ˜¯undo logï¼›è€ŒV1ã€V2ã€V3å¹¶ä¸æ˜¯ç‰©ç†ä¸ŠçœŸå®žå­˜åœ¨çš„ï¼Œè€Œæ˜¯æ¯æ¬¡éœ€è¦çš„æ—¶å€™æ ¹æ®å½“å‰ç‰ˆæœ¬å’Œundo logè®¡ç®—å‡ºæ¥çš„ã€‚ é‚£ä¹ˆInnoDBæ˜¯æ€Žä¹ˆå®šä¹‰å¿«ç…§çš„ï¼ŸæŒ‰ç…§å¯é‡å¤è¯»çš„å®šä¹‰ï¼Œä¸€ä¸ªäº‹åŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ‰€æœ‰å·²ç»æäº¤çš„äº‹åŠ¡ç»“æžœã€‚ä½†æ˜¯ä¹‹åŽï¼Œè¿™ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–äº‹åŠ¡çš„æ›´æ–°å¯¹å®ƒä¸å¯è§ åœ¨å®žçŽ°ä¸Šï¼Œ InnoDBä¸ºæ¯ä¸ªäº‹åŠ¡æž„é€ äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥ä¿å­˜è¿™ä¸ªäº‹åŠ¡å¯åŠ¨çž¬é—´ï¼Œå½“å‰æ­£åœ¨â€œæ´»è·ƒâ€çš„æ‰€æœ‰äº‹åŠ¡IDã€‚â€œæ´»è·ƒâ€æŒ‡çš„å°±æ˜¯ï¼Œå¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤ã€‚ æ•°ç»„é‡Œé¢äº‹åŠ¡IDçš„æœ€å°å€¼è®°ä¸ºä½Žæ°´ä½ï¼Œå½“å‰ç³»ç»Ÿé‡Œé¢å·²ç»åˆ›å»ºè¿‡çš„äº‹åŠ¡IDçš„æœ€å¤§å€¼åŠ 1è®°ä¸ºé«˜æ°´ä½ã€‚ è¿™ä¸ªè§†å›¾æ•°ç»„å’Œé«˜æ°´ä½ï¼Œå°±ç»„æˆäº†å½“å‰äº‹åŠ¡çš„ä¸€è‡´æ€§è§†å›¾ï¼ˆread-viewï¼‰ã€‚ è€Œæ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§è§„åˆ™ï¼Œå°±æ˜¯åŸºäºŽæ•°æ®çš„row trx_idå’Œè¿™ä¸ªä¸€è‡´æ€§è§†å›¾çš„å¯¹æ¯”ç»“æžœå¾—åˆ°çš„ã€‚ è¿™ä¸ªè§†å›¾æ•°ç»„æŠŠæ‰€æœ‰çš„row trx_id åˆ†æˆäº†å‡ ç§ä¸åŒçš„æƒ…å†µã€‚ è¿™æ ·ï¼Œå¯¹äºŽå½“å‰äº‹åŠ¡çš„å¯åŠ¨çž¬é—´æ¥è¯´ï¼Œä¸€ä¸ªæ•°æ®ç‰ˆæœ¬çš„row trx_idï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š å¦‚æžœè½åœ¨ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²æäº¤çš„äº‹åŠ¡æˆ–è€…æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å¯è§çš„ï¼› å¦‚æžœè½åœ¨çº¢è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±å°†æ¥å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ˜¯è‚¯å®šä¸å¯è§çš„ï¼› å¦‚æžœè½åœ¨é»„è‰²éƒ¨åˆ†ï¼Œé‚£å°±åŒ…æ‹¬ä¸¤ç§æƒ…å†µ a. è‹¥ row trx_idåœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±è¿˜æ²¡æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œä¸å¯è§ï¼› b. è‹¥ row trx_idä¸åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²ç»æäº¤äº†çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œå¯è§ã€‚ æœ‰äº†è¿™ä¸ªå£°æ˜ŽåŽï¼Œç³»ç»Ÿé‡Œé¢éšåŽå‘ç”Ÿçš„æ›´æ–°ï¼Œæ˜¯ä¸æ˜¯å°±è·Ÿè¿™ä¸ªäº‹åŠ¡çœ‹åˆ°çš„å†…å®¹æ— å…³äº†å‘¢ï¼Ÿå› ä¸ºä¹‹åŽçš„æ›´æ–°ï¼Œç”Ÿæˆçš„ç‰ˆæœ¬ä¸€å®šå±žäºŽä¸Šé¢çš„2æˆ–è€…3(a)çš„æƒ…å†µï¼Œè€Œå¯¹å®ƒæ¥è¯´ï¼Œè¿™äº›æ–°çš„æ•°æ®ç‰ˆæœ¬æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡çš„å¿«ç…§ï¼Œå°±æ˜¯â€œé™æ€â€çš„äº†ã€‚ æ‰€ä»¥ä½ çŽ°åœ¨çŸ¥é“äº†ï¼ŒInnoDBåˆ©ç”¨äº†â€œæ‰€æœ‰æ•°æ®éƒ½æœ‰å¤šä¸ªç‰ˆæœ¬â€çš„è¿™ä¸ªç‰¹æ€§ï¼Œå®žçŽ°äº†â€œç§’çº§åˆ›å»ºå¿«ç…§â€çš„èƒ½åŠ›ã€‚ ç»§ç»­çœ‹ä¸€ä¸‹å›¾1ä¸­çš„ä¸‰ä¸ªäº‹åŠ¡ï¼Œåˆ†æžä¸‹äº‹åŠ¡Açš„è¯­å¥è¿”å›žçš„ç»“æžœï¼Œä¸ºä»€ä¹ˆæ˜¯k=1ã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬ä¸å¦¨åšå¦‚ä¸‹å‡è®¾ï¼š äº‹åŠ¡Aå¼€å§‹å‰ï¼Œç³»ç»Ÿé‡Œé¢åªæœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡IDæ˜¯99ï¼› äº‹åŠ¡Aã€Bã€Cçš„ç‰ˆæœ¬å·åˆ†åˆ«æ˜¯100ã€101ã€102ï¼Œä¸”å½“å‰ç³»ç»Ÿé‡Œåªæœ‰è¿™å››ä¸ªäº‹åŠ¡ï¼› ä¸‰ä¸ªäº‹åŠ¡å¼€å§‹å‰ï¼Œ(1,1)è¿™ä¸€è¡Œæ•°æ®çš„row trx_idæ˜¯90ã€‚ è¿™æ ·ï¼Œäº‹åŠ¡Açš„è§†å›¾æ•°ç»„å°±æ˜¯[99,100], äº‹åŠ¡Bçš„è§†å›¾æ•°ç»„æ˜¯[99,100,101], äº‹åŠ¡Cçš„è§†å›¾æ•°ç»„æ˜¯[99,100,101,102]ã€‚ ä¸ºäº†ç®€åŒ–åˆ†æžï¼Œæˆ‘å…ˆæŠŠå…¶ä»–å¹²æ‰°è¯­å¥åŽ»æŽ‰ï¼Œåªç”»å‡ºè·Ÿäº‹åŠ¡AæŸ¥è¯¢é€»è¾‘æœ‰å…³çš„æ“ä½œï¼š ä»Žå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæœ‰æ•ˆæ›´æ–°æ˜¯äº‹åŠ¡Cï¼ŒæŠŠæ•°æ®ä»Ž(1,1)æ”¹æˆäº†(1,2)ã€‚è¿™æ—¶å€™ï¼Œè¿™ä¸ªæ•°æ®çš„æœ€æ–°ç‰ˆæœ¬çš„row trx_idæ˜¯102ï¼Œè€Œ90è¿™ä¸ªç‰ˆæœ¬å·²ç»æˆä¸ºäº†åŽ†å²ç‰ˆæœ¬ã€‚ ç¬¬äºŒä¸ªæœ‰æ•ˆæ›´æ–°æ˜¯äº‹åŠ¡Bï¼ŒæŠŠæ•°æ®ä»Ž(1,2)æ”¹æˆäº†(1,3)ã€‚è¿™æ—¶å€™ï¼Œè¿™ä¸ªæ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆå³row trx_idï¼‰æ˜¯101ï¼Œè€Œ102åˆæˆä¸ºäº†åŽ†å²ç‰ˆæœ¬ã€‚ ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œåœ¨äº‹åŠ¡AæŸ¥è¯¢çš„æ—¶å€™ï¼Œå…¶å®žäº‹åŠ¡Bè¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯å®ƒç”Ÿæˆçš„(1,3)è¿™ä¸ªç‰ˆæœ¬å·²ç»å˜æˆå½“å‰ç‰ˆæœ¬äº†ã€‚ä½†è¿™ä¸ªç‰ˆæœ¬å¯¹äº‹åŠ¡Aå¿…é¡»æ˜¯ä¸å¯è§çš„ï¼Œå¦åˆ™å°±å˜æˆè„è¯»äº†ã€‚ å¥½ï¼ŒçŽ°åœ¨äº‹åŠ¡Aè¦æ¥è¯»æ•°æ®äº†ï¼Œå®ƒçš„è§†å›¾æ•°ç»„æ˜¯[99,100]ã€‚å½“ç„¶äº†ï¼Œè¯»æ•°æ®éƒ½æ˜¯ä»Žå½“å‰ç‰ˆæœ¬è¯»èµ·çš„ã€‚æ‰€ä»¥ï¼Œäº‹åŠ¡AæŸ¥è¯¢è¯­å¥çš„è¯»æ•°æ®æµç¨‹æ˜¯è¿™æ ·çš„ï¼š æ‰¾åˆ°(1,3)çš„æ—¶å€™ï¼Œåˆ¤æ–­å‡ºrow trx_id=101ï¼Œæ¯”é«˜æ°´ä½å¤§ï¼Œå¤„äºŽçº¢è‰²åŒºåŸŸï¼Œä¸å¯è§ï¼› æŽ¥ç€ï¼Œæ‰¾åˆ°ä¸Šä¸€ä¸ªåŽ†å²ç‰ˆæœ¬ï¼Œä¸€çœ‹row trx_id=102ï¼Œæ¯”é«˜æ°´ä½å¤§ï¼Œå¤„äºŽçº¢è‰²åŒºåŸŸï¼Œä¸å¯è§ï¼› å†å¾€å‰æ‰¾ï¼Œç»ˆäºŽæ‰¾åˆ°äº†(1,1)ï¼Œå®ƒçš„row trx_id=90ï¼Œæ¯”ä½Žæ°´ä½å°ï¼Œå¤„äºŽç»¿è‰²åŒºåŸŸï¼Œå¯è§ã€‚ è¿™æ ·æ‰§è¡Œä¸‹æ¥ï¼Œè™½ç„¶æœŸé—´è¿™ä¸€è¡Œæ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œä½†æ˜¯äº‹åŠ¡Aä¸è®ºåœ¨ä»€ä¹ˆæ—¶å€™æŸ¥è¯¢ï¼Œçœ‹åˆ°è¿™è¡Œæ•°æ®çš„ç»“æžœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€è‡´æ€§è¯»ã€‚è¿™ä¸ªåˆ¤æ–­è§„åˆ™æ˜¯ä»Žä»£ç é€»è¾‘ç›´æŽ¥è½¬è¯‘è¿‡æ¥çš„ï¼Œä½†æ˜¯æ­£å¦‚ä½ æ‰€è§ï¼Œç”¨äºŽäººè‚‰åˆ†æžå¯è§æ€§å¾ˆéº»çƒ¦ã€‚ æ‰€ä»¥ç¿»è¯‘ä¸€ä¸‹ã€‚ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œå¯¹äºŽä¸€ä¸ªäº‹åŠ¡è§†å›¾æ¥è¯´ï¼Œé™¤äº†è‡ªå·±çš„æ›´æ–°æ€»æ˜¯å¯è§ä»¥å¤–ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š ç‰ˆæœ¬æœªæäº¤ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œä½†æ˜¯æ˜¯åœ¨è§†å›¾åˆ›å»ºåŽæäº¤çš„ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œè€Œä¸”æ˜¯åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„ï¼Œå¯è§ã€‚ å¯¹äºŽå¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ï¼Œè®°ä½è¿™ä¸ªè§„åˆ™å°±å¯ä»¥æ¥åˆ†æžäº†ã€‚ ðŸ”¥æ›´æ–°é€»è¾‘äº‹åŠ¡Bçš„updateè¯­å¥ï¼Œå¦‚æžœæŒ‰ç…§ä¸€è‡´æ€§è¯»ï¼Œå¥½åƒç»“æžœä¸å¯¹ï¼Ÿå¦‚ä¸‹å›¾ï¼Œäº‹åŠ¡Bçš„è§†å›¾æ•°ç»„æ˜¯å…ˆç”Ÿæˆçš„ï¼Œä¹‹åŽäº‹åŠ¡Cæ‰æäº¤ï¼Œä¸æ˜¯åº”è¯¥çœ‹ä¸è§(1,2)å—ï¼Œæ€Žä¹ˆèƒ½ç®—å‡º(1,3)æ¥çš„ï¼Ÿ æ˜¯çš„ï¼Œå¦‚æžœäº‹åŠ¡Båœ¨æ›´æ–°ä¹‹å‰æŸ¥è¯¢ä¸€æ¬¡æ•°æ®ï¼Œè¿™ä¸ªæŸ¥è¯¢è¿”å›žçš„kçš„å€¼ç¡®å®žæ˜¯1ã€‚ä½†æ˜¯ï¼Œå½“å®ƒè¦åŽ»æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¸èƒ½å†åœ¨åŽ†å²ç‰ˆæœ¬ä¸Šæ›´æ–°äº†ï¼Œå¦åˆ™äº‹åŠ¡Cçš„æ›´æ–°å°±ä¸¢å¤±äº†ã€‚å› æ­¤ï¼Œäº‹åŠ¡Bæ­¤æ—¶çš„set k=k+1æ˜¯åœ¨ï¼ˆ1,2ï¼‰çš„åŸºç¡€ä¸Šè¿›è¡Œçš„æ“ä½œã€‚ æ‰€ä»¥ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†è¿™æ ·ä¸€æ¡è§„åˆ™ï¼šæ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åŽå†™çš„ï¼Œè€Œè¿™ä¸ªè¯»ï¼Œåªèƒ½è¯»å½“å‰çš„å€¼ï¼Œç§°ä¸ºâ€œå½“å‰è¯»â€ï¼ˆcurrent readï¼‰ã€‚ å› æ­¤ï¼Œåœ¨æ›´æ–°çš„æ—¶å€™ï¼Œå½“å‰è¯»æ‹¿åˆ°çš„æ•°æ®æ˜¯(1,2)ï¼Œæ›´æ–°åŽç”Ÿæˆäº†æ–°ç‰ˆæœ¬çš„æ•°æ®(1,3)ï¼Œè¿™ä¸ªæ–°ç‰ˆæœ¬çš„row trx_idæ˜¯101ã€‚ å…¶å®žï¼Œé™¤äº†updateè¯­å¥å¤–ï¼Œselectè¯­å¥å¦‚æžœåŠ é”ï¼Œä¹Ÿæ˜¯å½“å‰è¯»ã€‚æ‰€ä»¥ï¼Œå¦‚æžœæŠŠäº‹åŠ¡Açš„æŸ¥è¯¢è¯­å¥select * from t where id=1ä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ ä¸Šlock in share mode æˆ– for updateï¼Œä¹Ÿéƒ½å¯ä»¥è¯»åˆ°ç‰ˆæœ¬å·æ˜¯101çš„æ•°æ®ï¼Œè¿”å›žçš„kçš„å€¼æ˜¯3ã€‚ä¸‹é¢è¿™ä¸¤ä¸ªselectè¯­å¥ï¼Œå°±æ˜¯åˆ†åˆ«åŠ äº†è¯»é”ï¼ˆSé”ï¼Œå…±äº«é”ï¼‰å’Œå†™é”ï¼ˆXé”ï¼ŒæŽ’ä»–é”ï¼‰ã€‚ 12select k from t where id=1 lock in share mode;select k from t where id=1 for update; å†è¿›ä¸€æ­¥ï¼Œå‡è®¾äº‹åŠ¡Cä¸æ˜¯é©¬ä¸Šæäº¤çš„ï¼Œè€Œæ˜¯å˜æˆäº†ä¸‹é¢çš„äº‹åŠ¡Câ€™ï¼ˆå¦‚ä¸‹å³å›¾æ‰€ç¤ºï¼‰ï¼Œä¼šæ€Žä¹ˆæ ·å‘¢ï¼Ÿ äº‹åŠ¡Câ€™çš„ä¸åŒæ˜¯ï¼Œæ›´æ–°åŽå¹¶æ²¡æœ‰é©¬ä¸Šæäº¤ï¼Œåœ¨å®ƒæäº¤å‰ï¼Œäº‹åŠ¡Bçš„æ›´æ–°è¯­å¥å…ˆå‘èµ·äº†ã€‚å‰é¢è¯´è¿‡äº†ï¼Œè™½ç„¶äº‹åŠ¡Câ€™è¿˜æ²¡æäº¤ï¼Œä½†æ˜¯(1,2)è¿™ä¸ªç‰ˆæœ¬ä¹Ÿå·²ç»ç”Ÿæˆäº†ï¼Œå¹¶ä¸”æ˜¯å½“å‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚é‚£ä¹ˆï¼Œäº‹åŠ¡Bçš„æ›´æ–°è¯­å¥ä¼šæ€Žä¹ˆå¤„ç†å‘¢ï¼Ÿ è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„â€œä¸¤é˜¶æ®µé”åè®®â€å°±è¦ä¸Šåœºäº†ã€‚äº‹åŠ¡Câ€™æ²¡æäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´(1,2)è¿™ä¸ªç‰ˆæœ¬ä¸Šçš„å†™é”è¿˜æ²¡é‡Šæ”¾ã€‚è€Œäº‹åŠ¡Bæ˜¯å½“å‰è¯»ï¼Œå¿…é¡»è¦è¯»æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œä¸”å¿…é¡»åŠ é”ï¼Œå› æ­¤å°±è¢«é”ä½äº†ï¼Œå¿…é¡»ç­‰åˆ°äº‹åŠ¡Câ€™é‡Šæ”¾è¿™ä¸ªé”ï¼Œæ‰èƒ½ç»§ç»­å®ƒçš„å½“å‰è¯»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º ç»¼ä¸Šæ‰€è¿°ï¼Œäº‹åŠ¡çš„å¯é‡å¤è¯»çš„èƒ½åŠ›æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Ÿ å¯é‡å¤è¯»çš„æ ¸å¿ƒå°±æ˜¯ä¸€è‡´æ€§è¯»ï¼ˆconsistent readï¼‰ï¼›è€Œäº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œåªèƒ½ç”¨å½“å‰è¯»ã€‚å¦‚æžœå½“å‰çš„è®°å½•çš„è¡Œé”è¢«å…¶ä»–äº‹åŠ¡å ç”¨çš„è¯ï¼Œå°±éœ€è¦è¿›å…¥é”ç­‰å¾…ã€‚è€Œè¯»æäº¤çš„é€»è¾‘å’Œå¯é‡å¤è¯»çš„é€»è¾‘ç±»ä¼¼ï¼Œå®ƒä»¬æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼š åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œåªéœ€è¦åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™åˆ›å»ºä¸€è‡´æ€§è§†å›¾ï¼Œä¹‹åŽäº‹åŠ¡é‡Œçš„å…¶ä»–æŸ¥è¯¢éƒ½å…±ç”¨è¿™ä¸ªä¸€è‡´æ€§è§†å›¾ï¼› åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸€ä¸ªè¯­å¥æ‰§è¡Œå‰éƒ½ä¼šé‡æ–°ç®—å‡ºä¸€ä¸ªæ–°çš„è§†å›¾ã€‚","link":"/2025/02/15/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"},{"title":"code-å¤šçº¿ç¨‹é¡ºåºæ‰“å°é—®é¢˜","text":"ä¸‰ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰“å° Aï¼ŒBï¼ŒCä¸‰ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰“å° Aï¼ŒBï¼ŒCï¼Œè¦æ±‚è¿™ä¸‰ä¸ªçº¿ç¨‹ä¸€èµ·è¿è¡Œï¼Œæ‰“å° n æ¬¡ï¼Œè¾“å‡ºå½¢å¦‚â€œABCABCABCâ€¦.â€çš„å­—ç¬¦ä¸² ä½¿ç”¨Lock12345678910111213141516171819202122232425262728293031323334353637383940import java.util.concurrent.locks.ReentrantLock;public class ABC { static class ABCPrinter { private final int times; // éœ€è¦æ‰“å°çš„æ¬¡æ•° private int state; // å­˜å‚¨çŠ¶æ€å€¼ï¼Œæ‰“å°å®Œæˆæ—¶è¯¥å€¼ä¼šå˜æˆ3*time-1 private final ReentrantLock lock; public ABCPrinter(int times) { this.times = times; this.lock = new ReentrantLock(); } public void print(Character key, int num) { int current = 0; while (current &lt; times) { lock.lock(); if (state % 3 == num) { // é€šè¿‡å–æ¨¡åˆ¤æ–­å½“å‰è¯¥å“ªä¸ªçº¿ç¨‹è¿›å…¥æ‰“å° System.out.println(key); state++; current++; } lock.unlock(); // æ‰“å°å®Œæˆæˆ–éžå½“å‰çº¿ç¨‹è½®æ¬¡ä¼šè¿›å…¥è§£é” } } } public static void main(String[] args) throws InterruptedException { final ABCPrinter abcPrinter = new ABCPrinter(10); Thread a = new Thread(() -&gt; abcPrinter.print('A', 0)); a.start(); Thread b = new Thread(() -&gt; abcPrinter.print('B', 1)); b.start(); Thread c = new Thread(() -&gt; abcPrinter.print('C', 2)); c.start(); a.join(); b.join(); c.join(); }} ä½¿ç”¨wait/notify12345678910111213141516171819202122232425262728293031323334353637383940414243public class ABC { static class ABCPrinter { private final int times; // éœ€è¦æ‰“å°çš„æ¬¡æ•° private int state; // å­˜å‚¨çŠ¶æ€å€¼ï¼Œæ‰“å°å®Œæˆæ—¶è¯¥å€¼ä¼šå˜æˆ3*time-1 private final static Object LOCK = new Object(); public ABCPrinter(int times) { this.times = times; } public void print(Character key, int num) { int current = 0; while (current &lt; times) { while (state % 3 != num) { synchronized(LOCK){ try { LOCK.wait(); } catch (InterruptedException e) { e.printStackTrace(); } } state++; current++; System.out.println(key); LOCK.notifyAll(); } } } } public static void main(String[] args) throws InterruptedException { final ABCPrinter abcPrinter = new ABCPrinter(10); Thread a = new Thread(() -&gt; abcPrinter.print('A', 0)); a.start(); Thread b = new Thread(() -&gt; abcPrinter.print('B', 1)); b.start(); Thread c = new Thread(() -&gt; abcPrinter.print('C', 2)); c.start(); a.join(); b.join(); c.join(); }} ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°0~100çš„å¥‡å¶æ•°ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°0~100çš„å¥‡å¶æ•° é€šè¿‡Nä¸ªçº¿ç¨‹é¡ºåºå¾ªçŽ¯æ‰“å°ä»Ž0è‡³100é€šè¿‡Nä¸ªçº¿ç¨‹é¡ºåºå¾ªçŽ¯æ‰“å°ä»Ž0è‡³100 å¤šçº¿ç¨‹æŒ‰é¡ºåºè°ƒç”¨æ‰“å°A-&gt;B-&gt;Cå¤šçº¿ç¨‹æŒ‰é¡ºåºè°ƒç”¨ï¼Œæ‰“å°A-&gt;B-&gt;Cï¼ŒAA æ‰“å° 5 æ¬¡ï¼ŒBB æ‰“å°10 æ¬¡ï¼ŒCC æ‰“å° 15 æ¬¡ï¼Œé‡å¤ 10 æ¬¡ ç”¨ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°æ•°å­—å’Œå­—æ¯ç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè¾“å‡ºå­—æ¯ï¼Œä¸€ä¸ªè¾“å‡ºæ•°å­—ï¼Œäº¤æ›¿è¾“å‡º 1A2B3C4Dâ€¦26Z","link":"/2025/03/08/code-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%A1%BA%E5%BA%8F%E6%89%93%E5%8D%B0%E9%97%AE%E9%A2%98/"},{"title":"pysparkåˆ†å¸ƒå¼è®­ç»ƒ","text":"","link":"/2022/07/03/pyspark%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/"},{"title":"åˆ†å¸ƒå¼äº‹åŠ¡ä¸ŽCAPç†è®º","text":"å¾…è¡¥å……","link":"/2022/07/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%8ECAP%E7%90%86%E8%AE%BA/"},{"title":"åˆ›å»ºç¬¬ä¸€ä¸ªAkkaåº”ç”¨","text":"å…³äºŽæœ¬æ–‡ ç‰ˆæœ¬ï¼š2.6ä¹‹åŽçš„ç‰ˆæœ¬ä¸ºæ”¶è´¹ç‰ˆæœ¬ï¼Œ2.6ç‰ˆæœ¬çš„scalaç‰ˆä½¿ç”¨æ–‡æ¡£è§v2.6ä½¿ç”¨æ–‡æ¡£ï¼Œflinkåœ¨ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªç‰ˆæœ¬ apiç±»åž‹ï¼šclassicæ¯”è¾ƒçµæ´»ï¼Œè¯•ç”¨ä¸€ä¸‹classicç‰ˆæœ¬çš„api æž„å»ºåº”ç”¨Demoé…ç½®å¦‚ä¸‹çš„pomæ–‡ä»¶ pom.xml >folded1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;tech.bravoqq&lt;/groupId&gt; &lt;artifactId&gt;demo-akka&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;scala.version&gt;2.12.19&lt;/scala.version&gt; &lt;scala.base.version&gt;2.12&lt;/scala.base.version&gt; &lt;akka.version&gt;2.6.21&lt;/akka.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt; &lt;artifactId&gt;akka-actor_${scala.base.version}&lt;/artifactId&gt; &lt;version&gt;${akka.version}&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;sourceDirectory&gt;src/main/scala&lt;/sourceDirectory&gt; &lt;testSourceDirectory&gt;src/test/scala&lt;/testSourceDirectory&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;net.alchim31.maven&lt;/groupId&gt; &lt;artifactId&gt;scala-maven-plugin&lt;/artifactId&gt; &lt;version&gt;4.9.2&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;goals&gt; &lt;goal&gt;compile&lt;/goal&gt; &lt;goal&gt;testCompile&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;scalaVersion&gt;${scala.version}&lt;/scalaVersion&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; å®˜æ–¹demoç»™åˆ°çš„æ˜¯ä¸€ä¸ªping-pongçš„ç³»ç»Ÿï¼Œå¦‚ä¸‹ï¼Œ Application.scala12345678910111213141516171819202122232425262728293031323334353637383940414243444546import akka.actor.{Actor, ActorRef, ActorSystem, PoisonPill, Props}import language.postfixOpsimport scala.concurrent.duration._case object Pingcase object Pongclass Pinger extends Actor { var countDown = 100 def receive = { case Pong =&gt; println(s&quot;${self.path} received pong, count down $countDown&quot;) if (countDown &gt; 0) { countDown -= 1 sender() ! Ping } else { sender() ! PoisonPill self ! PoisonPill } }}class Ponger(pinger: ActorRef) extends Actor { def receive = { case Ping =&gt; println(s&quot;${self.path} received ping&quot;) pinger ! Pong }}object Application extends App { val system = ActorSystem(&quot;pingpong&quot;) val pinger = system.actorOf(Props[Pinger](), &quot;pinger&quot;) val ponger = system.actorOf(Props(classOf[Ponger], pinger), &quot;ponger&quot;) import system.dispatcher system.scheduler.scheduleOnce(500 millis) { ponger ! Ping }}","link":"/2024/08/07/%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AAAkka%E5%BA%94%E7%94%A8/"}],"tags":[{"name":"Akka","slug":"Akka","link":"/tags/Akka/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","link":"/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"dolphinscheduler","slug":"dolphinscheduler","link":"/tags/dolphinscheduler/"},{"name":"MySQL","slug":"MySQL","link":"/tags/MySQL/"},{"name":"multithreading","slug":"multithreading","link":"/tags/multithreading/"},{"name":"CAP","slug":"CAP","link":"/tags/CAP/"}],"categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","link":"/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"è°ƒåº¦æœåŠ¡","slug":"è°ƒåº¦æœåŠ¡","link":"/categories/%E8%B0%83%E5%BA%A6%E6%9C%8D%E5%8A%A1/"},{"name":"Database","slug":"Database","link":"/categories/Database/"},{"name":"code","slug":"code","link":"/categories/code/"}]}